
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>Arch Linux Installation &amp; Maintenance &#8212; kuenishi(7)</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/material.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="ZFS Memo" href="zfs.html" />
    <link rel="prev" title="Open Source Contributions" href="../opensource.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=blue-grey data-md-color-accent=blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#memo/arch" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../index.html" title="kuenishi(7)"
           class="md-header-nav__button md-logo">
          
            &nbsp;
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">kuenishi(7)</span>
          <span class="md-header-nav__topic"> Arch Linux Installation &amp; Maintenance </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
      
  
  <script src="../_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../"versions.json"",
        target_loc = "../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="../index.html" class="md-tabs__link">kuenishi(7)</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../index.html" title="kuenishi(7)" class="md-nav__button md-logo">
      
        <img src="../_static/" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../index.html"
       title="kuenishi(7)">kuenishi(7)</a>
  </label>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#memo-arch--page-root" class="md-nav__link">Arch Linux Installation & Maintenance</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#iso-image-download" class="md-nav__link">ISO Image Download</a>
        </li>
        <li class="md-nav__item"><a href="#installation" class="md-nav__link">Installation</a>
        </li>
        <li class="md-nav__item"><a href="#gui" class="md-nav__link">GUI</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#weird-display-vibrarion" class="md-nav__link">Weird display vibrarion</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#id2" class="md-nav__link">日本語入力</a>
        </li>
        <li class="md-nav__item"><a href="#system-update" class="md-nav__link">System update</a>
        </li>
        <li class="md-nav__item"><a href="#installed-application" class="md-nav__link">Installed Application</a>
        </li>
        <li class="md-nav__item"><a href="#sound" class="md-nav__link">Sound</a>
        </li>
        <li class="md-nav__item"><a href="#wifi" class="md-nav__link">WiFi</a>
        </li>
        <li class="md-nav__item"><a href="#docker" class="md-nav__link">Docker</a>
        </li>
        <li class="md-nav__item"><a href="#gpg-keys" class="md-nav__link">GPG keys</a>
        </li>
        <li class="md-nav__item"><a href="#clamav" class="md-nav__link">ClamAV</a>
        </li>
        <li class="md-nav__item"><a href="#id6" class="md-nav__link">マルチ（外部）ディスプレイ</a>
        </li>
        <li class="md-nav__item"><a href="#windows-on-virtualbox" class="md-nav__link">Windows on VirtualBox</a>
        </li>
        <li class="md-nav__item"><a href="#yubikey-authentication" class="md-nav__link">YubiKey authentication</a>
        </li>
        <li class="md-nav__item"><a href="#todo" class="md-nav__link">TODO</a>
        </li>
        <li class="md-nav__item"><a href="#reference" class="md-nav__link">Reference</a>
        </li>
        <li class="md-nav__item"><a href="#arch-linux-installation-to-machine-2" class="md-nav__link">Arch Linux Installation to machine #2</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#os-install" class="md-nav__link">OS Install</a>
        </li>
        <li class="md-nav__item"><a href="#btrfs-setup" class="md-nav__link">Btrfs setup</a>
        </li>
        <li class="md-nav__item"><a href="#static-ip-address" class="md-nav__link">Static IP address</a>
        </li>
        <li class="md-nav__item"><a href="#nvidia-driver" class="md-nav__link">Nvidia driver</a>
        </li>
        <li class="md-nav__item"><a href="#install-yaourt" class="md-nav__link">Install yaourt</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#general-trouble-shooting" class="md-nav__link">General Trouble Shooting</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#locale" class="md-nav__link">Locale再生成</a>
        </li>
        <li class="md-nav__item"><a href="#mac-mini-mid-2011" class="md-nav__link">Mac Mini mid 2011 にインストール</a>
        </li>
        <li class="md-nav__item"><a href="#pacman-gnupg" class="md-nav__link">Pacman のアップデートで GnuPG エラーが出る</a>
        </li>
        <li class="md-nav__item"><a href="#fix-kernel-or-other-files-2018-4-6" class="md-nav__link">Fix kernel or other files 2018/4/6</a>
        </li>
        <li class="md-nav__item"><a href="#id9" class="md-nav__link">急にWiFiがつながらなくなったら</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
    
<li class="md-nav__item"><a class="md-nav__extra_link" href="../_sources/memo/arch.rst.txt">Show Source</a> </li>

<li id="searchbox" class="md-nav__item"></li>

  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <section id="arch-linux-installation-maintenance">
<h1 id="memo-arch--page-root">Arch Linux Installation &amp; Maintenance<a class="headerlink" href="#memo-arch--page-root" title="Permalink to this headline">¶</a></h1>
<p>2017/10/19 - 2017/10/20</p>
<p>2018/9/9 Mac mini mid 2011 のインストールを追加
2018/3/15 カーネルパッチの部分を削除
2018/4/6 Trouble Shooting追加
2020/6/17 btrfs まわりを追加</p>
<section id="iso-image-download">
<h2 id="iso-image-download">ISO Image Download<a class="headerlink" href="#iso-image-download" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://www.archlinux.org/download/">https://www.archlinux.org/download/</a> からPGP署名ファイルとISOイメージをダウンロード:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ wget http://ftp.jaist.ac.jp/pub/Linux/ArchLinux/iso/2017.10.01/archlinux-2017.10.01-x86_64.iso
$ wget https://www.archlinux.org/iso/2017.10.01/archlinux-2017.10.01-x86_64.iso.sig
$ ls archlinux*
archlinux-2017.10.01-x86_64.iso  archlinux-2017.10.01-x86_64.iso.sig
</pre></div>
</div>
<p>ダウンロードしたファイルの検証。公開鍵がないので一旦失敗する:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ LANG=C gpg --verbose --verify archlinux-2017.10.01-x86_64.iso.sig
gpg: assuming signed data in 'archlinux-2017.10.01-x86_64.iso'
gpg: Signature made Sun Oct  1 14:29:43 2017 JST
gpg:                using RSA key 4AA4767BBC9C4B1D18AE28B77F2D434B9741E8AC
gpg: Can't check signature: No public key
</pre></div>
</div>
<p>公開鍵を調べてとりあえずインポートする:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gpg --search-key 4AA4767BBC9C4B1D18AE28B77F2D434B9741E8AC
gpg: data source: https://176.9.147.41:443
(1)     Pierre Schmitz &lt;pierre@archlinux.de&gt;
        2048 bit RSA key 7F2D434B9741E8AC, 作成: 2011-04-10
Keys 1-1 of 1 for "4AA4767BBC9C4B1D18AE28B77F2D434B9741E8AC".  番号(s)、N)次、またはQ)中止を入力してください &gt;N
$ gpg --recv-keys  7F2D434B9741E8AC
gpg: 鍵7F2D434B9741E8AC: 公開鍵"Pierre Schmitz &lt;pierre@archlinux.de&gt;"をインポートしました
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: 深さ: 0  有効性:   2  署名:   1  信用: 0-, 0q, 0n, 0m, 0f, 2u
gpg: 深さ: 1  有効性:   1  署名:   0  信用: 0-, 0q, 0n, 0m, 1f, 0u
gpg: 次回の信用データベース検査は、2018-07-11です
gpg:           処理数の合計: 1
gpg:             インポート: 1
</pre></div>
</div>
<p>改めてVerify:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ LANG=C gpg --verify archlinux-2017.10.01-x86_64.iso.sig
gpg: assuming signed data in 'archlinux-2017.10.01-x86_64.iso'
gpg: Signature made Sun Oct  1 14:29:43 2017 JST
gpg:                using RSA key 4AA4767BBC9C4B1D18AE28B77F2D434B9741E8AC
gpg: Good signature from "Pierre Schmitz &lt;pierre@archlinux.de&gt;" [unknown]
gpg: WARNING: This key is not certified with a trusted signature!
gpg:          There is no indication that the signature belongs to the owner.
Primary key fingerprint: 4AA4 767B BC9C 4B1D 18AE  28B7 7F2D 434B 9741 E8AC
</pre></div>
</div>
<p><a class="reference external" href="https://wiki.archlinux.jp/index.php/USB_%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%83%A1%E3%83%87%E3%82%A3%E3%82%A2">イメージをUSBメモリに焼く</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo dmesg | tail
[ 6587.846736] scsi 8:0:0:0: Direct-Access     Ut165    USB2FlashStorage 0.00 PQ: 0 ANSI: 2
[ 6587.847379] sd 8:0:0:0: Attached scsi generic sg6 type 0
[ 6587.848372] sd 8:0:0:0: [sdf] 7897040 512-byte logical blocks: (4.04 GB/3.76 GiB)
[ 6587.849183] sd 8:0:0:0: [sdf] Write Protect is off
[ 6587.849185] sd 8:0:0:0: [sdf] Mode Sense: 00 00 00 00
[ 6587.850081] sd 8:0:0:0: [sdf] Asking for cache data failed
[ 6587.850087] sd 8:0:0:0: [sdf] Assuming drive cache: write through
[ 6588.007742]  sdf:
[ 6588.400298] sd 8:0:0:0: [sdf] Attached SCSI removable disk
[ 7272.546160]  sdf: sdf1 sdf2
$ sudo dd if=archlinux-2017.10.01-x86_64.iso of=/dev/sdf status=progress &amp;&amp; sudo sync
544993792 bytes (545 MB, 520 MiB) copied, 189 s, 2.9 MB/s
1071104+0 レコード入力
1071104+0 レコード出力
548405248 bytes (548 MB, 523 MiB) copied, 201.131 s, 2.7 MB/s
</pre></div>
</div>
</section>
<section id="installation">
<h2 id="installation">Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>ThinkPad届く。</p>
<p>Secure Bootをオフに必ずしておく。
Bootパスはまあこの際後でもいっか。</p>
<p>Windows Proのライセンスキーがパッケージや本体のどこにも書いてないので、
Windowsを起動して一旦プロダクトキーを抜いておく（おそらくThinkPadのCPU
IDかシリアルナンバーか何かをみて認証していると思われる。ブート後:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># passwd</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># systemctl start sshd</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># ip addr</span>
</pre></div>
</div>
<p>以後SSHで入って作業（優先で接続するために予めRJ45アダプタを買っておく）。ディスク名を確認:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># fdisk -l</span>
<span class="n">Disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span><span class="p">:</span> <span class="mi">477</span> <span class="n">GiB</span><span class="p">,</span> <span class="mi">512110190592</span> <span class="nb">bytes</span><span class="p">,</span> <span class="mi">1000215216</span> <span class="n">sectors</span>
<span class="n">Units</span><span class="p">:</span> <span class="n">sectors</span> <span class="n">of</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">=</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">Sector</span> <span class="n">size</span> <span class="p">(</span><span class="n">logical</span><span class="o">/</span><span class="n">physical</span><span class="p">):</span> <span class="mi">512</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">size</span> <span class="p">(</span><span class="n">minimum</span><span class="o">/</span><span class="n">optimal</span><span class="p">):</span> <span class="mi">512</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">Disklabel</span> <span class="nb">type</span><span class="p">:</span> <span class="n">gpt</span>
<span class="n">Disk</span> <span class="n">identifier</span><span class="p">:</span> <span class="mi">25</span><span class="n">A27C49</span><span class="o">-</span><span class="mi">25</span><span class="n">BC</span><span class="o">-</span><span class="mi">4715</span><span class="o">-</span><span class="mi">8</span><span class="n">A09</span><span class="o">-</span><span class="n">A722ABE9260D</span>

<span class="n">Device</span>             <span class="n">Start</span>        <span class="n">End</span>   <span class="n">Sectors</span>   <span class="n">Size</span> <span class="n">Type</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>      <span class="mi">2048</span>     <span class="mi">534527</span>    <span class="mi">532480</span>   <span class="mi">260</span><span class="n">M</span> <span class="n">EFI</span> <span class="n">System</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p2</span>    <span class="mi">534528</span>     <span class="mi">567295</span>     <span class="mi">32768</span>    <span class="mi">16</span><span class="n">M</span> <span class="n">Microsoft</span> <span class="n">reserved</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p3</span>    <span class="mi">567296</span>  <span class="mi">998166527</span> <span class="mi">997599232</span> <span class="mf">475.7</span><span class="n">G</span> <span class="n">Microsoft</span> <span class="n">basic</span> <span class="n">data</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p4</span> <span class="mi">998166528</span> <span class="mi">1000214527</span>   <span class="mi">2048000</span>  <span class="mi">1000</span><span class="n">M</span> <span class="n">Windows</span> <span class="n">recovery</span> <span class="n">environment</span>
</pre></div>
</div>
<p>パーティションを切る:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># parted /dev/nvme0n1 -s mklabel gpt -s mkpart ESP fat32 1MiB 513MiB -s set 1 boot on -s mkpart primary ext4 513MiB 100%</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># fdisk -l</span>
<span class="n">Disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span><span class="p">:</span> <span class="mi">477</span> <span class="n">GiB</span><span class="p">,</span> <span class="mi">512110190592</span> <span class="nb">bytes</span><span class="p">,</span> <span class="mi">1000215216</span> <span class="n">sectors</span>
<span class="n">Units</span><span class="p">:</span> <span class="n">sectors</span> <span class="n">of</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">=</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">Sector</span> <span class="n">size</span> <span class="p">(</span><span class="n">logical</span><span class="o">/</span><span class="n">physical</span><span class="p">):</span> <span class="mi">512</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">size</span> <span class="p">(</span><span class="n">minimum</span><span class="o">/</span><span class="n">optimal</span><span class="p">):</span> <span class="mi">512</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">Disklabel</span> <span class="nb">type</span><span class="p">:</span> <span class="n">gpt</span>
<span class="n">Disk</span> <span class="n">identifier</span><span class="p">:</span> <span class="mf">1E26</span><span class="n">B015</span><span class="o">-</span><span class="n">ABC4</span><span class="o">-</span><span class="mi">4949</span><span class="o">-</span><span class="mi">8410</span><span class="o">-</span><span class="mi">7</span><span class="n">F43A11ECE11</span>

<span class="n">Device</span>           <span class="n">Start</span>        <span class="n">End</span>   <span class="n">Sectors</span>   <span class="n">Size</span> <span class="n">Type</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>    <span class="mi">2048</span>    <span class="mi">1050623</span>   <span class="mi">1048576</span>   <span class="mi">512</span><span class="n">M</span> <span class="n">EFI</span> <span class="n">System</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p2</span> <span class="mi">1050624</span> <span class="mi">1000214527</span> <span class="mi">999163904</span> <span class="mf">476.4</span><span class="n">G</span> <span class="n">Linux</span> <span class="n">filesystem</span>
</pre></div>
</div>
<p>ブートセクタをフォーマットする:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># mkfs.vfat -F32 /dev/nvme0n1p1</span>
<span class="n">mkfs</span><span class="o">.</span><span class="n">fat</span> <span class="mf">4.1</span> <span class="p">(</span><span class="mi">2017</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">24</span><span class="p">)</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># parted /dev/nvme0n1 print</span>
<span class="n">Model</span><span class="p">:</span> <span class="n">Unknown</span> <span class="p">(</span><span class="n">unknown</span><span class="p">)</span>
<span class="n">Disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span><span class="p">:</span> <span class="mi">512</span><span class="n">GB</span>
<span class="n">Sector</span> <span class="n">size</span> <span class="p">(</span><span class="n">logical</span><span class="o">/</span><span class="n">physical</span><span class="p">):</span> <span class="mi">512</span><span class="n">B</span><span class="o">/</span><span class="mi">512</span><span class="n">B</span>
<span class="n">Partition</span> <span class="n">Table</span><span class="p">:</span> <span class="n">gpt</span>
<span class="n">Disk</span> <span class="n">Flags</span><span class="p">:</span>

<span class="n">Number</span>  <span class="n">Start</span>   <span class="n">End</span>    <span class="n">Size</span>   <span class="n">File</span> <span class="n">system</span>  <span class="n">Name</span>  <span class="n">Flags</span>
<span class="mi">1</span>      <span class="mi">1049</span><span class="n">kB</span>  <span class="mi">538</span><span class="n">MB</span>  <span class="mi">537</span><span class="n">MB</span>  <span class="n">fat32</span>              <span class="n">boot</span><span class="p">,</span> <span class="n">esp</span>
<span class="mi">2</span>      <span class="mi">538</span><span class="n">MB</span>   <span class="mi">512</span><span class="n">GB</span>  <span class="mi">512</span><span class="n">GB</span>
</pre></div>
</div>
<p>ルートパーティションを暗号化する。このとき入れるパスワードが、マシン起
動のときに毎回きかれるパスワードになる。このパスワードを覚えておけばあ
とで追加もできる。というか、覚えられるパスワードにしておこう。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>root@archiso ~ # cryptsetup luksFormat /dev/nvme0n1p2

WARNING!
========
This will overwrite data on /dev/nvme0n1p2 irrevocably.

Are you sure? (Type uppercase yes): YES
Enter passphrase:
Verify passphrase:
</pre></div>
</div>
<p>LUKSはかなり高機能で、YubiKeyで鍵を渡して起動とか、USBメモリ上の特定の
パスから拾ってくるとかいろいろできるらしい。initrdの中にパスワードファ
イルを仕込んでおくこともできるが、ここは素直に覚えやすいものを設定して
おくことにした。暗号化したやつをDevice Mapperで見えるようにする。ここ
では <code class="docutils literal notranslate"><span class="pre">crypt-root</span></code> と適当に名前をつける。それを ext4 でフォーマットま
でしとく。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># cryptsetup open /dev/nvme0n1p2 crypt-root</span>
<span class="n">Enter</span> <span class="n">passphrase</span> <span class="k">for</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p2</span><span class="p">:</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># mkfs.ext4 /dev/mapper/crypt-root</span>
<span class="n">mke2fs</span> <span class="mf">1.43.6</span> <span class="p">(</span><span class="mi">29</span><span class="o">-</span><span class="n">Aug</span><span class="o">-</span><span class="mi">2017</span><span class="p">)</span>
<span class="n">Creating</span> <span class="n">filesystem</span> <span class="k">with</span> <span class="mi">124894976</span> <span class="mi">4</span><span class="n">k</span> <span class="n">blocks</span> <span class="ow">and</span> <span class="mi">31227904</span> <span class="n">inodes</span>
<span class="n">Filesystem</span> <span class="n">UUID</span><span class="p">:</span> <span class="mi">01</span><span class="n">dbc4c4</span><span class="o">-</span><span class="n">bebe</span><span class="o">-</span><span class="mi">4</span><span class="n">ee5</span><span class="o">-</span><span class="mi">92</span><span class="n">a1</span><span class="o">-</span><span class="mi">2568</span><span class="n">aaef4c1f</span>
<span class="n">Superblock</span> <span class="n">backups</span> <span class="n">stored</span> <span class="n">on</span> <span class="n">blocks</span><span class="p">:</span>
      <span class="mi">32768</span><span class="p">,</span> <span class="mi">98304</span><span class="p">,</span> <span class="mi">163840</span><span class="p">,</span> <span class="mi">229376</span><span class="p">,</span> <span class="mi">294912</span><span class="p">,</span> <span class="mi">819200</span><span class="p">,</span> <span class="mi">884736</span><span class="p">,</span> <span class="mi">1605632</span><span class="p">,</span> <span class="mi">2654208</span><span class="p">,</span>
      <span class="mi">4096000</span><span class="p">,</span> <span class="mi">7962624</span><span class="p">,</span> <span class="mi">11239424</span><span class="p">,</span> <span class="mi">20480000</span><span class="p">,</span> <span class="mi">23887872</span><span class="p">,</span> <span class="mi">71663616</span><span class="p">,</span> <span class="mi">78675968</span><span class="p">,</span>
      <span class="mi">102400000</span>

      <span class="n">Allocating</span> <span class="n">group</span> <span class="n">tables</span><span class="p">:</span> <span class="n">done</span>
      <span class="n">Writing</span> <span class="n">inode</span> <span class="n">tables</span><span class="p">:</span> <span class="n">done</span>
      <span class="n">Creating</span> <span class="n">journal</span> <span class="p">(</span><span class="mi">262144</span> <span class="n">blocks</span><span class="p">):</span> <span class="n">done</span>
      <span class="n">Writing</span> <span class="n">superblocks</span> <span class="ow">and</span> <span class="n">filesystem</span> <span class="n">accounting</span> <span class="n">information</span><span class="p">:</span> <span class="n">done</span>
</pre></div>
</div>
<p>フォーマットしたものをと、ブートパーティションをマウントする。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># mount /dev/mapper/crypt-root /mnt</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># mount /dev/nvme0n1p1 /mnt/boot</span>
<span class="n">mount</span><span class="p">:</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="p">:</span> <span class="n">mount</span> <span class="n">point</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">exist</span><span class="o">.</span>
<span class="mi">32</span> <span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># mkdir /mnt/boot</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># mount /dev/nvme0n1p1 /mnt/boot</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># timedatectl set-ntp true</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># timedatectl status</span>
      <span class="n">Local</span> <span class="n">time</span><span class="p">:</span> <span class="n">Thu</span> <span class="mi">2017</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span> <span class="mi">03</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">12</span> <span class="n">UTC</span>
  <span class="n">Universal</span> <span class="n">time</span><span class="p">:</span> <span class="n">Thu</span> <span class="mi">2017</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span> <span class="mi">03</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">12</span> <span class="n">UTC</span>
        <span class="n">RTC</span> <span class="n">time</span><span class="p">:</span> <span class="n">Thu</span> <span class="mi">2017</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span> <span class="mi">03</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">12</span>
       <span class="n">Time</span> <span class="n">zone</span><span class="p">:</span> <span class="n">UTC</span> <span class="p">(</span><span class="n">UTC</span><span class="p">,</span> <span class="o">+</span><span class="mi">0000</span><span class="p">)</span>
 <span class="n">Network</span> <span class="n">time</span> <span class="n">on</span><span class="p">:</span> <span class="n">yes</span>
<span class="n">NTP</span> <span class="n">synchronized</span><span class="p">:</span> <span class="n">yes</span>
 <span class="n">RTC</span> <span class="ow">in</span> <span class="n">local</span> <span class="n">TZ</span><span class="p">:</span> <span class="n">no</span>
</pre></div>
</div>
<p>ミラーを日本だけのものにしとく。grepだと ‘–’ という余計なものが入るの
で、消しておくこと。ベースシステムを <code class="docutils literal notranslate"><span class="pre">pacstrap</span></code> でインストールしてか
ら、この時点で <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> を作っておく。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> # grep Japan -A 1 /etc/pacman.d/mirrorlist &gt; mirrorlist
 (remove  -- here)
 # vi mirrorlist
 # mv mirrorlist /etc/pacman.d/
 # pacstrap /mnt base base-devel linux linux-firmware
 # genfstab -U /mnt &gt;&gt; /mnt/etc/fstab

``chroot`` して、OS環境の作成を開始する。まず、基本的なファイルを先においておく。::

 root@archiso ~ # arch-chroot /mnt
 [root@archiso /]# ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
 [root@archiso /]# echo "LANG=en_US.UTF-8" &gt; /etc/locale.conf
 [root@archiso /]# locale-gen
 [root@archiso /]# echo KEYMAP=us &gt; /etc/vconsole.conf
 [root@archiso /]# echo utaha &gt; /etc/hostname
 [root@archiso /]# pacman -S emacs-nox
 [root@archiso /]# emacs /etc/hosts
 (set hostname.localdomain)
</pre></div>
</div>
<p>ひととおり設定できたら、initramfsを作る。 <code class="docutils literal notranslate"><span class="pre">/etc/mkinitcpio.conf</span></code> を
編集して、 <code class="docutils literal notranslate"><span class="pre">systemd</span></code> と <code class="docutils literal notranslate"><span class="pre">sd-encrypt</span></code> を <a class="reference external" href="https://wiki.archlinux.org/index.php/Dm-crypt/System_configuration#mkinitcpio">HOOKSに追加する</a>
。いまのところはこういう並びでうまくいっている。 <code class="docutils literal notranslate"><span class="pre">sd-encrypt</span></code> は <code class="docutils literal notranslate"><span class="pre">block</span></code> の前にないとだめそう。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HOOKS</span><span class="o">=</span><span class="s2">"base systemd udev autodetect modconf sd-encrypt block filesystems keyboard fsck"</span>
</pre></div>
</div>
<p>巷には LVM と <code class="docutils literal notranslate"><span class="pre">encrypt</span></code> を使ってなぜか <code class="docutils literal notranslate"><span class="pre">systemd-boot</span></code> でうまく行っ
ている例があるみたいだが、少なくとも手元では成功しなかったので鵜呑みに
するのは危険だろう。 <a class="reference external" href="https://bbs.archlinux.org/viewtopic.php?pid=1673320#p1673320">If you use the systemd hook then you have to use
sd-encrypt and
sd-lvm.</a>
とも書いてあるし。これが編集できたら initrd を作成。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># mkinitcpio -p linux</span>
</pre></div>
</div>
<p>次はブートセクタの作成。まずUUIDを確認して、とりあえずもろもろのファイルを作っておく。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cryptsetup luksUUID /dev/nvme0n1p2</span>
<span class="mi">1</span><span class="n">cf54a61</span><span class="o">-</span><span class="n">cd17</span><span class="o">-</span><span class="mf">43e3</span><span class="o">-</span><span class="n">ad00</span><span class="o">-</span><span class="n">bf94c29dc922</span>
<span class="c1"># bootctl --path=/boot install</span>
<span class="c1"># pacman -S intel-ucode</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">intel-ucode</span></code> は <a class="reference external" href="https://wiki.archlinux.jp/index.php/%E3%83%9E%E3%82%A4%E3%82%AF%E3%83%AD%E3%82%B3%E3%83%BC%E3%83%89#Intel_.E3.81.AE.E3.83.9E.E3.82.A4.E3.82.AF.E3.83.AD.E3.82.B3.E3.83.BC.E3.83.89.E3.81.AE.E3.82.A2.E3.83.83.E3.83.97.E3.83.87.E3.83.BC.E3.83.88.E3.82.92.E6.9C.89.E5.8A.B9.E3.81.AB.E3.81.99.E3.82.8B">CPUのマイクロコードをアップデートしてくれるものらしい</a> 。</p>
<p>次にブートローダの設定を作成。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># emacs /boot/loader/loader.conf</span>
<span class="c1"># cat /boot/loader/loader.conf</span>
<span class="n">timeout</span> <span class="mi">5</span>
<span class="c1">## default 64783ef8e33e4205862d8f26c79b569c-*</span>
<span class="n">default</span> <span class="n">encrypted</span><span class="o">-</span><span class="n">arch</span><span class="o">.</span><span class="n">conf</span>
<span class="n">editor</span> <span class="mi">0</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">timeout</span> <span class="pre">5</span></code> は、ブートローダーに入ってから、ブートエントリの切り替え
を5秒だけ待ってくれるやつだ。5秒たつとデフォルトのブートエントリに入っ
ていく。デフォルトのブートエントリは:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cat /boot/loader/entries/encrypted-arch.conf</span>
<span class="n">title</span> <span class="n">Arch</span> <span class="n">Linux</span> <span class="n">Encrypted</span>
<span class="n">linux</span> <span class="o">/</span><span class="n">vmlinuz</span><span class="o">-</span><span class="n">linux</span>
<span class="n">initrd</span> <span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">ucode</span><span class="o">.</span><span class="n">img</span>
<span class="n">initrd</span> <span class="o">/</span><span class="n">initramfs</span><span class="o">-</span><span class="n">linux</span><span class="o">.</span><span class="n">img</span>
<span class="n">options</span> <span class="n">luks</span><span class="o">.</span><span class="n">uuid</span><span class="o">=</span><span class="mi">1</span><span class="n">cf54a61</span><span class="o">-</span><span class="n">cd17</span><span class="o">-</span><span class="mf">43e3</span><span class="o">-</span><span class="n">ad00</span><span class="o">-</span><span class="n">bf94c29dc922</span> <span class="n">luks</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="mi">1</span><span class="n">cf54a61</span><span class="o">-</span><span class="n">cd17</span><span class="o">-</span><span class="mf">43e3</span><span class="o">-</span><span class="n">ad00</span><span class="o">-</span><span class="n">bf94c29dc922</span><span class="o">=</span><span class="n">crypt</span><span class="o">-</span><span class="n">root</span> <span class="n">root</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">crypt</span><span class="o">-</span><span class="n">root</span> <span class="n">rw</span> <span class="n">intel_pstate</span><span class="o">=</span><span class="n">no_hwp</span>
</pre></div>
</div>
<p><a class="reference external" href="https://wiki.archlinux.jp/index.php/Dm-crypt/%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E8%A8%AD%E5%AE%9A">↑はdm-cryptのやつ</a> をみながら編集した。</p>
<p>起動したときにファイルシステムのパスフレーズを要求されて、 login ttyが出れば成功。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># sync</span>
<span class="c1"># systemctl reboot</span>
</pre></div>
</div>
<p>しかしこれでは後々マウスが動かないので、あとでこのカーネルをAURでアップデートすることになる。</p>
<ul class="simple">
<li><p><a class="reference external" href="https://wiki.archlinux.jp/index.php/Systemd-boot">https://wiki.archlinux.jp/index.php/Systemd-boot</a></p></li>
</ul>
</section>
<section id="gui">
<h2 id="gui">GUI<a class="headerlink" href="#gui" title="Permalink to this headline">¶</a></h2>
<p>まずは基本的なユーザー作成:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># mkdir /home/kuenishi
# chown kuenishi:kuenishi /home/kuenishi
# useradd kuenishi
# passwd kuenishi
# vigr -&gt; add kuenishi to wheel
# pacman -S sudo
# visudo -&gt; enable wheel as ALL=ALL
$ sudo pacman -S git
</pre></div>
</div>
<p>このままだと <a class="reference external" href="https://wiki.archlinux.jp/index.php/Lenovo_ThinkPad_X1_Carbon_(Gen_5)#.E3.83.88.E3.83.A9.E3.83.83.E3.82.AF.E3.83.9D.E3.82.A4.E3.83.B3.E3.83.88.2F.E3.83.88.E3.83.A9.E3.83.83.E3.82.AF.E3.83.91.E3.83.83.E3.83.89.E3.81.8C.E6.A9.9F.E8.83.BD.E3.81.97.E3.81.AA.E3.81.84">トラックポイント/トラックパッドが機能しない</a>
という問題にぶつかるので、それを回避するため設定を入れる。
<code class="docutils literal notranslate"><span class="pre">psmouse.synaptics_intertouch=1</span></code> をカーネルパラメータに追加する。カー
ネルパラメータを設定するには
<code class="docutils literal notranslate"><span class="pre">/boot/loader/entries/encrypted-arch.conf</span></code> を書き換える。カーネルと
initrd の新しいファイルが <code class="docutils literal notranslate"><span class="pre">/boot</span></code> に置かれているので、両方を置き換え
たら再起動。たとえばこんな感じ(<code class="docutils literal notranslate"><span class="pre">-tp-x1-carbon-5th</span></code> がついているもの
は 4.14 からはもう不要になった):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ls /boot</span>
<span class="n">EFI</span>                                            <span class="n">initramfs</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">tp</span><span class="o">-</span><span class="n">x1</span><span class="o">-</span><span class="n">carbon</span><span class="o">-</span><span class="mi">5</span><span class="n">th</span><span class="o">.</span><span class="n">img</span>  <span class="n">loader</span>
<span class="n">initramfs</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">fallback</span><span class="o">.</span><span class="n">img</span>                   <span class="n">initramfs</span><span class="o">-</span><span class="n">linux</span><span class="o">.</span><span class="n">img</span>                   <span class="n">vmlinuz</span><span class="o">-</span><span class="n">linux</span>
<span class="n">initramfs</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">tp</span><span class="o">-</span><span class="n">x1</span><span class="o">-</span><span class="n">carbon</span><span class="o">-</span><span class="mi">5</span><span class="n">th</span><span class="o">-</span><span class="n">fallback</span><span class="o">.</span><span class="n">img</span>  <span class="n">intel</span><span class="o">-</span><span class="n">ucode</span><span class="o">.</span><span class="n">img</span>                       <span class="n">vmlinuz</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">tp</span><span class="o">-</span><span class="n">x1</span><span class="o">-</span><span class="n">carbon</span><span class="o">-</span><span class="mi">5</span><span class="n">th</span>
<span class="c1"># cat /boot/loader/entries/encrypted-arch.conf</span>
<span class="n">title</span> <span class="n">Arch</span> <span class="n">Linux</span> <span class="n">Encrypted</span>
<span class="n">linux</span> <span class="o">/</span><span class="n">vmlinuz</span><span class="o">-</span><span class="n">linux</span>
<span class="n">initrd</span> <span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">ucode</span><span class="o">.</span><span class="n">img</span>
<span class="n">initrd</span> <span class="o">/</span><span class="n">initramfs</span><span class="o">-</span><span class="n">linux</span><span class="o">.</span><span class="n">img</span>
<span class="n">options</span> <span class="n">luks</span><span class="o">.</span><span class="n">uuid</span><span class="o">=</span><span class="mi">1</span><span class="n">cf54a61</span><span class="o">-</span><span class="n">cd17</span><span class="o">-</span><span class="mf">43e3</span><span class="o">-</span><span class="n">ad00</span><span class="o">-</span><span class="n">bf94c29dc922</span> <span class="n">luks</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="mi">1</span><span class="n">cf54a61</span><span class="o">-</span><span class="n">cd17</span><span class="o">-</span><span class="mf">43e3</span><span class="o">-</span><span class="n">ad00</span><span class="o">-</span><span class="n">bf94c29dc922</span><span class="o">=</span><span class="n">crypt</span><span class="o">-</span><span class="n">root</span> <span class="n">root</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">crypt</span><span class="o">-</span><span class="n">root</span> <span class="n">rw</span> <span class="n">intel_pstate</span><span class="o">=</span><span class="n">no_hwp</span> <span class="n">psmouse</span><span class="o">.</span><span class="n">synaptics_intertouch</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p>Enlightenment を少し試してみたが、使いにくいので xfce4 に戻る。インストールと起動テスト:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo pacman -S xorg-server xfce4 xfce4-goodies
$ startxfce4
</pre></div>
</div>
<p>これで起動を確認する。変なことになって失敗したら <code class="docutils literal notranslate"><span class="pre">Ctrl+Alt+Del</span></code> で戻
れる。lightdm は最初失敗。ログをみるのもだるいので sddm に。  <a class="reference external" href="https://wiki.archlinux.jp/index.php/%E3%83%87%E3%82%A3%E3%82%B9%E3%83%97%E3%83%AC%E3%82%A4%E3%83%9E%E3%83%8D%E3%83%BC%E3%82%B8%E3%83%A3">SDDM を
有効にするには</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo pacman -S sddm
$ sudo systemctl enable sddm
</pre></div>
</div>
<p>これでリブートしてみる。テストしたければ enable 前に <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">sddm</span></code> で。
CtrlとCaps Lockを入れ替えるのは、とりあえず:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ echo 'setxkbmap -option ctrl:nocaps' &gt; swapctrlcaps.sh
$ chmod 755 swapctrlcaps.sh
$ ./swapctrlcaps.sh
</pre></div>
</div>
<p>で Caps lock を Ctrl にする。他にもキーボードマッピングをいじる方法と
かがあるけど、複数のものが絡まって複雑になると困ってしまうので、なるべ
く上位でやりたいので今ここ。</p>
<p>DPIはAppearance （外観）から変更。とりあえず字大きめの160で。</p>
<section id="weird-display-vibrarion">
<h3 id="weird-display-vibrarion">Weird display vibrarion<a class="headerlink" href="#weird-display-vibrarion" title="Permalink to this headline">¶</a></h3>
<p>Sometimes a screen vibrates suddenly with a dmesg line including <code class="docutils literal notranslate"><span class="pre">[drm:intel_cpu_fifo_underrun_irq_handler</span> <span class="pre">[i915]]</span> <span class="pre">*ERROR*</span> <span class="pre">CPU</span> <span class="pre">pipe</span> <span class="pre">A</span> <span class="pre">FIFO</span> <span class="pre">underrun</span></code>  … which may be solved with installing <code class="docutils literal notranslate"><span class="pre">xf86-video-intel</span></code>  .</p>
<ul class="simple">
<li><p><a class="reference external" href="https://bbs.archlinux.org/viewtopic.php?id=198157">Linux console goes crazy (“cpu pipe a fifo underrun”) when Xorg quits.</a></p></li>
</ul>
</section>
</section>
<section id="id2">
<h2 id="id2">日本語入力<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://wiki.archlinux.jp/index.php/%E3%83%95%E3%82%A9%E3%83%B3%E3%83%88#.E6.97.A5.E6.9C.AC.E8.AA.9E">Japanese fonts</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo pacman -S noto-fonts-cjk noto-fonts-emoji noto-fonts-extra adobe-source-han-sans-jp-fonts otf-ipafont ttf-sazanami ttf-hanazono
$ sudo pacman -S fcitx-im fcitx-mozc fcitx-configtool
$ echo 'export GTK_IM_MODULE=fcitx
export XMODIFIERS=@im=fcitx' &gt; ~/.xprofile
</pre></div>
</div>
<p>で一旦ログアウトして、いろいろGUIをいじっていたら動いた。もしかしたら:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ fcitx-autostart
</pre></div>
</div>
<p>が必要かも。どうにも変だったら <code class="docutils literal notranslate"><span class="pre">fcitx-diagnose</span></code> こまんどで原因調査するとよい。 <a class="reference external" href="https://wiki.archlinux.jp/index.php/ロケール">ろけーるが変だった</a> ことがある。</p>
<p>Properly render PDF without embedded Japanese fonts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo pacman -S poppler-data
</pre></div>
</div>
</section>
<section id="system-update">
<h2 id="system-update">System update<a class="headerlink" href="#system-update" title="Permalink to this headline">¶</a></h2>
<p>システムアップデートは</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo pacman -Syu
</pre></div>
</div>
<p>このときAURで入れていたパッケージに注意すること。</p>
<p>パッケージを探すのは:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pacman -Ss &lt;pkgname&gt;
</pre></div>
</div>
</section>
<section id="installed-application">
<h2 id="installed-application">Installed Application<a class="headerlink" href="#installed-application" title="Permalink to this headline">¶</a></h2>
<p>いろんなアプリを入れる:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo pacman -S tmux firefox emacs slock
$ sudo pacman -S bash-completion
</pre></div>
</div>
<p>Spotlightのようなアプリケーションランチャーがあると便利だなと思ってい
たが <a class="reference external" href="http://www.webupd8.org/2014/06/xfce-app-launcher-whisker-menu-sees-new.html">Whisker Menu</a>
を <a class="reference external" href="http://thinkonbytes.blogspot.jp/2014/04/xubuntu-open-whisker-menu-with-windows.html">Windowsキーに割り当て</a>
て一見落着。</p>
<p><a class="reference external" href="https://wiki.archlinux.jp/index.php/Slock">Slock</a> is just a screen
locker. Type ‘slock’ when you leave your seat temporariliy or for a
long time. -&gt; <a class="reference external" href="https://wiki.archlinux.org/index.php/List_of_applications/Security#Screen_lockers">Other screen lockers</a></p>
<p><code class="docutils literal notranslate"><span class="pre">bash-completion</span></code> があれば、ターミナルに出た適当な長さのワードを拾って補完してくれるので特にzshとかいらない。</p>
<p>AURでは <code class="docutils literal notranslate"><span class="pre">yaourt</span></code> だけを入れる。 <code class="docutils literal notranslate"><span class="pre">package-query</span></code> に依存しているので、それを先に入れる。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git clone https://aur.archlinux.org/package-query.git
$ cd package-query
$ makepkg -is
$ cd ..
$ git clone https://aur.archlinux.org/yaourt.git
$ cd yaourt
$ makepkg -is
$ cd ..
</pre></div>
</div>
<p>いろいろ入れる:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ yaourt -S --noconfirm google-chrome slack-desktop gyazo
</pre></div>
</div>
</section>
<section id="sound">
<h2 id="sound">Sound<a class="headerlink" href="#sound" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://wiki.archlinux.jp/index.php/Advanced_Linux_Sound_Architecture">サウンド</a> は:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo pacman -S alsa-utils
$ alsamixer
</pre></div>
</div>
<p>これだけで音が鳴るようになる。 <a class="reference external" href="https://wiki.archlinux.org/index.php/xfce#Keyboard_volume_buttons">XfceのUI</a>
や、ThinkPadのF1~F3 でのコントロールはできていない。Xfce4のPulseAudio
pluginは <code class="docutils literal notranslate"><span class="pre">pavucontrol</span></code> をインストールして再起動？したら使えるように
なった。</p>
<p>-&gt; <a class="reference external" href="https://wiki.archlinux.org/index.php/List_of_applications#Volume_managers">https://wiki.archlinux.org/index.php/List_of_applications#Volume_managers</a></p>
</section>
<section id="wifi">
<h2 id="wifi">WiFi<a class="headerlink" href="#wifi" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://wiki.archlinux.org/index.php/Wicd">Wicd</a> を入れたらそれなりに快適に動く:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo pacman -S wicd wicd-gtk gksu python2-notify
$ sudo systemctl enable wicd
$ sudo systemctl start wicd
</pre></div>
</div>
<p><a class="reference external" href="https://wiki.archlinux.jp/index.php/WPA_supplicant">WiFi</a> なぜか一
度適当に設定したらいつの間にか動くようになってしまった…　電波強度をパ
ネルに出すのに wavelan というのをつけてある。ツールは他にも
<code class="docutils literal notranslate"><span class="pre">wifi-menu</span></code> とかいろいろある。-&gt;
<a class="reference external" href="https://wiki.archlinux.jp/index.php/%E3%83%AF%E3%82%A4%E3%83%A4%E3%83%AC%E3%82%B9%E8%A8%AD%E5%AE%9A">https://wiki.archlinux.jp/index.php/%E3%83%AF%E3%82%A4%E3%83%A4%E3%83%AC%E3%82%B9%E8%A8%AD%E5%AE%9A</a></p>
<p>WPA2 Enterpriseでクライアント認証でWiFi APに接続するときに、 EAP-TLSで
接続してPKCS#12の秘密鍵とパスフレーズだけで接続する場合にはなぜかWicd
ではうまく接続できず、結局 <code class="docutils literal notranslate"><span class="pre">netctl</span></code> でやった。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo systemctl stop wicd
$ sudo systemctl disable wicd
$ sudo pacman -R wicd wicd-gtk
$ sudo pacman -S netctl
$ sudo netctl list
$ sudo wifi-menu wlp4s0
(...find the SSID of WPA2 Enterprise and try to setup...)
$ sudoedit /etc/netctl/wlp4s0-&lt;ssid&gt;
$ cat /etc/netctl/wlp4s0-&lt;ssid&gt;
Description='Automatically generated profile by wifi-menu'
Interface=wlp4s0
Connection=wireless
Security=wpa-configsection
IP=dhcp
WPAConfigSection=(
      'ssid="hoge"'
      'key_mgmt=WPA-EAP'
      'eap=TLS'
      'proto=WPA RSN'
      'identity="kuenishi"'
      'private_key="/home/kuenishi/.pki/kuenishi_aho.p12"'
      'private_key_passwd="**********"'
      'priority=1'
      'phase2="auth=PAP"'
)
</pre></div>
</div>
<p>このファイルはたしか
<code class="docutils literal notranslate"><span class="pre">/etc/netctl/examples/wireless-wpa-configsection</span></code> からのコピペだった
気がする。これで接続できたら systemd 設定をする。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo netctl list
* wlp4s0-hoge
$ sudo netctl enable wlp4s0-hoge
</pre></div>
</div>
</section>
<section id="docker">
<h2 id="docker">Docker<a class="headerlink" href="#docker" title="Permalink to this headline">¶</a></h2>
<p>インストールしたら自分をDockerグループに入れて一旦ログアウト（グループ追加を有効にするため）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo pacman -S docker
$ vigr
$ exit (WMもログアウト）
</pre></div>
</div>
<p>その後Daemonを上げてアクセス:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo systemctl start docker
$ docker run -it ubuntu /bin/bash
</pre></div>
</div>
</section>
<section id="gpg-keys">
<h2 id="gpg-keys">GPG keys<a class="headerlink" href="#gpg-keys" title="Permalink to this headline">¶</a></h2>
<p>GPG key setup esp. pinentry:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cat .gnupg/gpg-agent.conf
# PIN entry program
# pinentry-program /usr/bin/pinentry-curses
# pinentry-program /usr/bin/pinentry-qt
# pinentry-program /usr/bin/pinentry-kwallet

pinentry-program /usr/bin/pinentry-gtk-2
</pre></div>
</div>
<p><a class="reference external" href="http://kuenishi.hatenadiary.jp/entry/2016/07/12/013041">GPG signature は作成またはインポート</a> する。Gitも
それで。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ git config --global gpg.program gpg2
$ gpg2 --list-secret-keys
$ git config --global user.signingkey xxxxxxxx
$ git log --show-signature
$ git tag -s tagname
$ git show tagname
</pre></div>
</div>
<ul class="simple">
<li><p><a class="reference external" href="https://www.gnupg.org/gph/en/manual/x334.html">https://www.gnupg.org/gph/en/manual/x334.html</a></p></li>
<li><p><a class="reference external" href="https://github.com/kuenishi/baccounts">baccounts</a> -&gt; GnuPG 2.0ま
でのフォーマットしか対応してないが、新しい GnuPG だと旧フォーマット
で出力できる。自前で GnuPG 1.x を入れてると pacman-keyring とかと干
渉してシステムアップデートできなくなるトラブルがあったので、自前では
入れずに公式でやること。</p></li>
</ul>
</section>
<section id="clamav">
<h2 id="clamav">ClamAV<a class="headerlink" href="#clamav" title="Permalink to this headline">¶</a></h2>
<p>セキュリティチェックでウイルスソフトが必要なのでインストール:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo pacman -S clamav
$ sudo freshclam
$ sudo systemctl enable freshclamd.service
$ sudo systemctl start freshclamd.service
$ sudo systemctl enable clamd.service
$ sudo systemctl start clamd.service
</pre></div>
</div>
<p>実際にウイルス検知ができるかチェックする:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ curl http://www.eicar.org/download/eicar.com.txt | clamscan -
</pre></div>
</div>
<p>以下が出力されれば検出成功です:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stdin</span><span class="p">:</span> <span class="n">Eicar</span><span class="o">-</span><span class="n">Test</span><span class="o">-</span><span class="n">Signature</span> <span class="n">FOUND</span>
</pre></div>
</div>
<p><a class="reference external" href="https://wiki.archlinux.jp/index.php/ClamAV">Further info</a></p>
</section>
<section id="id6">
<h2 id="id6">マルチ（外部）ディスプレイ<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<p>家のASUSの4KディスプレイはHDMIを刺すだけで特になにもなく 3000x2000 く
らいで認識されて映った。なにかあったら <a class="reference external" href="https://wiki.archlinux.jp/index.php/%E3%83%9E%E3%83%AB%E3%83%81%E3%83%87%E3%82%A3%E3%82%B9%E3%83%97%E3%83%AC%E3%82%A4">マルチディスプレイ</a>
を参照。</p>
</section>
<section id="windows-on-virtualbox">
<h2 id="windows-on-virtualbox">Windows on VirtualBox<a class="headerlink" href="#windows-on-virtualbox" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://www.microsoft.com/ja-jp/software-download/windows10ISO">Windows 10 Downlaod</a> からダウンロードしつつ、VirtualBoxをインストールする:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo pacman -S virtualbox virtualbox-guest-iso vde2
</pre></div>
</div>
<p>Windows予定のイメージを作ってDVDブートすると <code class="docutils literal notranslate"><span class="pre">VT-x</span> <span class="pre">is</span> <span class="pre">disabled</span> <span class="pre">in</span> <span class="pre">the</span>
<span class="pre">BIOS</span> <span class="pre">for</span> <span class="pre">all</span> <span class="pre">CPU</span> <span class="pre">modes</span></code> と叱られたので、BIOSで設定をオンにする。最近
は VT-d とかいうのまであるらしい。</p>
<p>予めWindowsのプロダクトキーは Windows Product Key Viewer というので抜
いておいた。ふつうにインストールできているっぽい。</p>
<p>image:: windows10-product-key-thinkpad-x1c-5th.jpg</p>
</section>
<section id="yubikey-authentication">
<h2 id="yubikey-authentication">YubiKey authentication<a class="headerlink" href="#yubikey-authentication" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://developers.yubico.com/yubico-pam/Authentication_Using_Challenge-Response.html">Local Authentication Using Challenge Response</a>
would be enough to prove personality, with 2FA. YubiCloud requires
network connectivity and its not given for free…:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo pacman -S yubico-pam
(insert yubikey)
$ mkdir ~/.yubico
$ ykpamcfg -2 -v
(a file will be saved to ~/.yubico/challenge-xxxxxx)
</pre></div>
</div>
<p>Move challenge-xxx file to <code class="docutils literal notranslate"><span class="pre">/var/yubico</span></code> following instructions
described in the page above; and in Arch <code class="docutils literal notranslate"><span class="pre">/etc/pam.d/system-auth</span></code> is
used rather than <code class="docutils literal notranslate"><span class="pre">common-auth</span></code> in the document. Before hand, make
sure you have another terminal window with root privilege just in case
to roll back <code class="docutils literal notranslate"><span class="pre">system-auth</span></code> file. The edit will be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudoedit /etc/pam.d/system-auth
(add
'auth   required        pam_yubico.so mode=challenge-response chalresp_path=/var/yubico'
after a line of pam_unix.so)
$ cat /etc/pam.d/system-auth
#%PAM-1.0

auth      required  pam_unix.so     try_first_pass nullok
auth      required  pam_yubico.so mode=challenge-response chalresp_path=/var/yubico
auth      optional  pam_permit.so
auth      required  pam_env.so
(.. snip ..)
</pre></div>
</div>
<p>Wait for moment, and test with <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">-s</span></code> which will block after you
input sudo password and the YubiKey is waiting for your touch.</p>
<p>See also:  <a class="reference external" href="https://developers.yubico.com/yubico-pam/Manuals/ykpamcfg.1.html">ykpamcfg(1)</a></p>
</section>
<section id="todo">
<h2 id="todo">TODO<a class="headerlink" href="#todo" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>いつの間にかF1~F12 のキーのうちいくつかが使えるようになっていた。不思議</p></li>
<li><p>YubiKeyを入れるとキーボードのCaps Lockが戻ってしまう</p></li>
<li><p>pacman/AURのフロントエンドを何か選ぶ -&gt; <a class="reference external" href="https://wiki.archlinux.org/index.php/AUR_helpers">https://wiki.archlinux.org/index.php/AUR_helpers</a> -&gt; とりあえず <code class="docutils literal notranslate"><span class="pre">yaourt</span></code> で困っていない。</p></li>
<li><p><a class="reference external" href="https://wiki.archlinux.jp/index.php/Yubikey#OpenPGP_.E3.82.B9.E3.83.9E.E3.83.BC.E3.83.88.E3.82.AB.E3.83.BC.E3.83.89.E3.83.A2.E3.83.BC.E3.83.89.E3.82.92.E6.9C.89.E5.8A.B9.E5.8C.96">OpenPGP のスマートカード有効化</a></p></li>
</ul>
</section>
<section id="reference">
<h2 id="reference">Reference<a class="headerlink" href="#reference" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://wiki.archlinux.jp/index.php/%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%82%AC%E3%82%A4%E3%83%89">インストールガイド</a></p></li>
<li><p><a class="reference external" href="https://wiki.archlinux.org/index.php/Lenovo_ThinkPad_X1_Carbon_(Gen_5)">Lenovo ThinkPad X1 Carbon (Gen 5)</a></p></li>
<li><p><a class="reference external" href="http://www.thinkwiki.org/wiki/Category:X1_Carbon_(5th_Gen)">Category:X1 Carbon (5th Gen)</a></p></li>
<li><p><a class="reference external" href="https://gist.github.com/HardenedArray/31915e3d73a4ae45adc0efa9ba458b07">Efficient Encrypted UEFI-Booting Arch Installation</a></p></li>
<li><p><a class="reference external" href="https://qiita.com/miy4/items/796c51813417cc90c77f">Thinkpad X1 Carbon (Gen 4)にArch Linuxをインストールする</a> &lt;- なぜ systemd hook をつけてないのに systemd-boot でブートローダーが作れるんだ？</p></li>
</ul>
</section>
<section id="arch-linux-installation-to-machine-2">
<h2 id="arch-linux-installation-to-machine-2">Arch Linux Installation to machine #2<a class="headerlink" href="#arch-linux-installation-to-machine-2" title="Permalink to this headline">¶</a></h2>
<p>2018/2/4</p>
<p>To my desktop machine, with NVIDIA GeForce 760, and several hetero HDDs.</p>
<section id="os-install">
<h3 id="os-install">OS Install<a class="headerlink" href="#os-install" title="Permalink to this headline">¶</a></h3>
<p>Same os above, using many tools to setup Arch Installation, except for:</p>
<ul class="simple">
<li><p>No HDD encryption</p></li>
<li><p>No kernel build for ThinkPad; it’s just commodity desktop</p></li>
<li><p>Btrfs for /home: <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">mount</span> <span class="pre">/mnt/home</span> <span class="pre">/dev/sdb</span></code> where sdb is one of Btrfs disks</p></li>
<li><p>Static IP address configuration</p></li>
<li><p>NVIDIA driver</p></li>
</ul>
</section>
<section id="btrfs-setup">
<h3 id="btrfs-setup">Btrfs setup<a class="headerlink" href="#btrfs-setup" title="Permalink to this headline">¶</a></h3>
<p>See <a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/Using_Btrfs_with_Multiple_Devices">Using Btrfs with Multiple Devices</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># mkfs.btrfs -d single /dev/sdb /dev/sdc /dev/sdd /dev/sde</span>
<span class="c1"># mount /dev/sde /mnt</span>
</pre></div>
</div>
<p>単体の例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># mkfs.btrfs -d single /dev/sdf</span>
<span class="n">btrfs</span><span class="o">-</span><span class="n">progs</span> <span class="n">v5</span><span class="mf">.6.1</span>
<span class="n">See</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">btrfs</span><span class="o">.</span><span class="n">wiki</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">org</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>

<span class="n">Detected</span> <span class="n">a</span> <span class="n">SSD</span><span class="p">,</span> <span class="n">turning</span> <span class="n">off</span> <span class="n">metadata</span> <span class="n">duplication</span><span class="o">.</span>  <span class="n">Mkfs</span> <span class="k">with</span> <span class="o">-</span><span class="n">m</span> <span class="n">dup</span> <span class="k">if</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">force</span> <span class="n">metadata</span> <span class="n">duplication</span><span class="o">.</span>
<span class="n">Label</span><span class="p">:</span>              <span class="p">(</span><span class="n">null</span><span class="p">)</span>
<span class="n">UUID</span><span class="p">:</span>               <span class="n">e092a2dc</span><span class="o">-</span><span class="n">b65d</span><span class="o">-</span><span class="mf">45e4</span><span class="o">-</span><span class="mi">8</span><span class="n">dee</span><span class="o">-</span><span class="mi">46529</span><span class="n">c1949a0</span>
<span class="n">Node</span> <span class="n">size</span><span class="p">:</span>          <span class="mi">16384</span>
<span class="n">Sector</span> <span class="n">size</span><span class="p">:</span>        <span class="mi">4096</span>
<span class="n">Filesystem</span> <span class="n">size</span><span class="p">:</span>    <span class="mf">931.51</span><span class="n">GiB</span>
<span class="n">Block</span> <span class="n">group</span> <span class="n">profiles</span><span class="p">:</span>
  <span class="n">Data</span><span class="p">:</span>             <span class="n">single</span>            <span class="mf">8.00</span><span class="n">MiB</span>
  <span class="n">Metadata</span><span class="p">:</span>         <span class="n">single</span>            <span class="mf">8.00</span><span class="n">MiB</span>
  <span class="n">System</span><span class="p">:</span>           <span class="n">single</span>            <span class="mf">4.00</span><span class="n">MiB</span>
<span class="n">SSD</span> <span class="n">detected</span><span class="p">:</span>       <span class="n">yes</span>
<span class="n">Incompat</span> <span class="n">features</span><span class="p">:</span>  <span class="n">extref</span><span class="p">,</span> <span class="n">skinny</span><span class="o">-</span><span class="n">metadata</span>
<span class="n">Checksum</span><span class="p">:</span>           <span class="n">crc32c</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">devices</span><span class="p">:</span>  <span class="mi">1</span>
<span class="n">Devices</span><span class="p">:</span>
   <span class="n">ID</span>        <span class="n">SIZE</span>  <span class="n">PATH</span>
    <span class="mi">1</span>   <span class="mf">931.51</span><span class="n">GiB</span>  <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdf</span>
</pre></div>
</div>
<p>マウントしてサブボリュームを作る:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># mount /dev/sdf /mnt</span>
<span class="c1"># btrfs sub create /mnt/kuenishi</span>
<span class="c1"># chown kuenishi:kuenishi /mnt/kuenishi</span>
</pre></div>
</div>
<p>いろいろファイルをコピーする:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd
$ mv -v * /mnt/kuenishi/
$ cp -v -r .* /mnt/kuenishi/
</pre></div>
</div>
<p>サブボリュームを <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> に書く:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UUID</span><span class="o">=</span><span class="n">e092a2dc</span><span class="o">-</span><span class="n">b65d</span><span class="o">-</span><span class="mf">45e4</span><span class="o">-</span><span class="mi">8</span><span class="n">dee</span><span class="o">-</span><span class="mi">46529</span><span class="n">c1949a0</span>       <span class="o">/</span><span class="n">home</span>           <span class="n">btrfs</span>           <span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">space_cache</span><span class="p">,</span><span class="n">subvolid</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">subvol</span><span class="o">=/</span>     <span class="mi">0</span> <span class="mi">0</span>
</pre></div>
</div>
<p>これで再起動するとホームディレクトリが btrfs のパーティションになっているはずだ。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo btrfs filesystem show /home
Label: none  uuid: e092a2dc-b65d-45e4-8dee-46529c1949a0
        Total devices 1 FS bytes used 32.64GiB
        devid    1 size 931.51GiB used 36.01GiB path /dev/sdf
</pre></div>
</div>
<p>以前作った大きめの btrfs ボリュームが <code class="docutils literal notranslate"><span class="pre">/data</span></code> にあるものとする。予め
スナップショット用のサブボリュームを作っておく。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># btrfs sub create /home/ss</span>
<span class="c1"># btrfs sub create /data/home-backup</span>
</pre></div>
</div>
<p>今度はバックアップを実行する。シェルにしてしまった。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/sh

set -eux

TS=`date '+%Y%m%d-%H%M%S'`
btrfs sub snap /home/kuenishi /home/ss/kuenishi-${TS}
btrfs property set -ts /home/ss/kuenishi-${TS} ro true
btrfs send /home/ss/kuenishi-${TS} | btrfs receive /data/home-backup
btrfs sub delete /home/ss/kuenishi-${TS}
</pre></div>
</div>
<p>これであとは適当にcronにでもしておけばよい。あとは Docker を使っている
場合、レイヤーを btrfs に保存する方法は簡単で、 <code class="docutils literal notranslate"><span class="pre">btrfs</span> <span class="pre">sub</span> <span class="pre">create</span>
<span class="pre">/data/docker</span></code> とやってサブボリュームを作っておく。それから、
<code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> に:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UUID</span><span class="o">=</span><span class="mi">5</span><span class="n">fdf336d</span><span class="o">-</span><span class="mi">09</span><span class="n">b3</span><span class="o">-</span><span class="mi">4</span><span class="n">b98</span><span class="o">-</span><span class="mf">8e52</span><span class="o">-</span><span class="n">d78b72ceedcf</span>       <span class="o">/</span><span class="n">data</span>           <span class="n">btrfs</span>           <span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">space_cache</span><span class="p">,</span><span class="n">subvolid</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">subvol</span><span class="o">=/</span>     <span class="mi">0</span> <span class="mi">0</span>
<span class="n">UUID</span><span class="o">=</span><span class="mi">5</span><span class="n">fdf336d</span><span class="o">-</span><span class="mi">09</span><span class="n">b3</span><span class="o">-</span><span class="mi">4</span><span class="n">b98</span><span class="o">-</span><span class="mf">8e52</span><span class="o">-</span><span class="n">d78b72ceedcf</span>       <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span>         <span class="n">btrfs</span>           <span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">space_cache</span><span class="p">,</span><span class="n">subvol</span><span class="o">=</span><span class="n">docker</span>   <span class="mi">0</span> <span class="mi">0</span>
</pre></div>
</div>
<p>とかいておくと、 <code class="docutils literal notranslate"><span class="pre">/data</span></code> にも使われているボリュームを名前を変えて
<code class="docutils literal notranslate"><span class="pre">/var/lib/docker</span></code> に置き換えて使ってくれる。Dockerの方でも、btrfs で
あることを検知して勝手にoverlayしてくれるようになる。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ df -h /data /var/lib/docker
Filesystem      Size  Used Avail Use% Mounted on
/dev/sdb        1.8T  461G  784G  37% /data
/dev/sdb        1.8T  461G  784G  37% /var/lib/docker
</pre></div>
</div>
<p>マシンを再起動する前に一度 <code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">/var/lib/docker/*</span></code> を実行して綺麗
にしておいた方がよいだろう。ちなみにしばらく使ったあとに <code class="docutils literal notranslate"><span class="pre">btrfs</span> <span class="pre">sub</span>
<span class="pre">list</span> <span class="pre">/data</span></code> すると大量のレイヤーが表示されて、Dockerが使われているこ
とがよくわかる。</p>
</section>
<section id="static-ip-address">
<h3 id="static-ip-address">Static IP address<a class="headerlink" href="#static-ip-address" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://wiki.archlinux.jp/index.php/Netctl#.E6.9C.89.E7.B7.9A">Use netctl</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ip a</span>
<span class="o">...</span> <span class="p">(</span><span class="n">see</span> <span class="n">device</span> <span class="n">name</span><span class="p">)</span> <span class="o">...</span>
<span class="c1"># cd /etc/netctl</span>
<span class="c1"># cp examples/ethernet-static enp4s0</span>
<span class="c1"># emacs enp4s0</span>
<span class="o">...</span>
<span class="c1"># cat enp4s0</span>
<span class="n">Interface</span><span class="o">=</span><span class="n">enp1s0</span>
<span class="n">Connection</span><span class="o">=</span><span class="n">ethernet</span>
<span class="n">IP</span><span class="o">=</span><span class="n">static</span>
<span class="n">Address</span><span class="o">=</span><span class="p">(</span><span class="s1">'10.1.10.2/24'</span><span class="p">)</span>
<span class="n">Gateway</span><span class="o">=</span><span class="s1">'10.1.10.1'</span>
<span class="n">DNS</span><span class="o">=</span><span class="p">(</span><span class="s1">'10.1.10.1'</span><span class="p">)</span>
<span class="c1"># netctl start enp4s0   // to start now</span>
<span class="c1"># netctl enable enp4s0  // to enable it on startup</span>
</pre></div>
</div>
<p>Don’t do any fucking typoes here. Troutbleshoot with <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">journalctl</span> <span class="pre">-xe</span></code>, like <a class="reference external" href="https://bbs.archlinux.org/viewtopic.php?id=161263">this</a> .</p>
</section>
<section id="nvidia-driver">
<h3 id="nvidia-driver">Nvidia driver<a class="headerlink" href="#nvidia-driver" title="Permalink to this headline">¶</a></h3>
<p>Nouvearu is kind of general and just works - but was too slow for me
at runtime. With <a class="reference external" href="https://wiki.archlinux.org/index.php/NVIDIA">official guide</a> you can find your device version:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ lspci -k | grep -A 2 -E "(VGA|3D)"
</pre></div>
</div>
</section>
<section id="install-yaourt">
<h3 id="install-yaourt">Install yaourt<a class="headerlink" href="#install-yaourt" title="Permalink to this headline">¶</a></h3>
<p>Obsolete… yaourt is not maintained any more.</p>
</section>
</section>
<section id="general-trouble-shooting">
<h2 id="general-trouble-shooting">General Trouble Shooting<a class="headerlink" href="#general-trouble-shooting" title="Permalink to this headline">¶</a></h2>
<section id="locale">
<h3 id="locale">Locale再生成<a class="headerlink" href="#locale" title="Permalink to this headline">¶</a></h3>
<p>ロケールが変になったらいつでも作り直すことができる。
<code class="docutils literal notranslate"><span class="pre">/etc/locale.gen</span></code> を編集して、必要なロケールのコメントアウトをとりの
ぞく。そのあと再度:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo locale-gen
</pre></div>
</div>
<p>と実行することでロケールが作成される。</p>
<ul class="simple">
<li><p><a class="reference external" href="https://wiki.archlinux.jp/index.php/%E3%83%AD%E3%82%B1%E3%83%BC%E3%83%AB">https://wiki.archlinux.jp/index.php/%E3%83%AD%E3%82%B1%E3%83%BC%E3%83%AB</a></p></li>
</ul>
</section>
<section id="mac-mini-mid-2011">
<h3 id="mac-mini-mid-2011">Mac Mini mid 2011 にインストール<a class="headerlink" href="#mac-mini-mid-2011" title="Permalink to this headline">¶</a></h3>
<p>2018/9の時点で <a class="reference external" href="https://apple-history.com/mac_mini_mid_11">mid 2011</a>
のモデルが最後のアップデート。もうMacOSは動かないくらいのスペックなの
で、 Arch Linux を入れた。 <a class="reference external" href="https://support.apple.com/ja-jp/HT202796">ブート USB を指して、 Options キーを押しな
がら起動するとブートセレクタに入れる</a> 。 WiFi はBCM43xxなので、
ブート用のISOには入っていないので、有線ネットワークのアクセスがインストールのためには必要。</p>
<p>インストール後は有線がセットアップされていないので:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo pacman -S dhcpcd
$ sudo systemctl start dhcpcd
$ sudo systemctl enable dhcpcd
</pre></div>
</div>
<p>WiFiを使うために</p>
<ul class="simple">
<li><p><a class="reference external" href="https://aur.archlinux.org/packages/yay/">yay</a> をインストール</p></li>
<li><p><a class="reference external" href="https://wiki.archlinux.org/index.php/broadcom_wireless#b43">b43</a> をインストール</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">broadcom-wl</span></code> もインストールして再起動。 dmesg で BCM4331 が見えていることを確認</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">cp</span> <span class="pre">/etc/netctl/examples/wireless-wpa</span> <span class="pre">/etc/netctl/&lt;profile-name&gt;</span></code> をやって内容を編集</p></li>
<li><p>デバイス名は <code class="docutils literal notranslate"><span class="pre">ip</span> <span class="pre">link</span></code> で一覧して結果を確認。それらの内容を <code class="docutils literal notranslate"><span class="pre">/etc/netctl/&lt;profile-name&gt;</span></code> に書き込む</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">netctl;</span> <span class="pre">sudo</span> <span class="pre">netctl</span> <span class="pre">start</span> <span class="pre">&lt;profile-name&gt;</span></code></p></li>
<li><p><a class="reference external" href="https://wiki.archlinux.jp/index.php/Netctl">netctl</a></p></li>
<li><p>多分これでいける</p></li>
</ul>
<p>xorg入れたけどなぜかGUIがでてこない</p>
</section>
<section id="pacman-gnupg">
<h3 id="pacman-gnupg">Pacman のアップデートで GnuPG エラーが出る<a class="headerlink" href="#pacman-gnupg" title="Permalink to this headline">¶</a></h3>
<p>パッケージアップデート時に <code class="docutils literal notranslate"><span class="pre">gnupg:</span> <span class="pre">signature</span> <span class="pre">from</span> <span class="pre">"Gaetan</span> <span class="pre">Bisson</span>
<span class="pre">&lt;bisson@archlinux.org&gt;"</span> <span class="pre">is</span> <span class="pre">invalid</span></code> 的なエラーがでて失敗したら、以下
の手順でキーを更新する:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo rm /var/lib/pacman/sync/*
$ sudo pacman-key --init
$ sudo pacman-key --populate archlinux
$ sudo pacman-key --refresh-keys
</pre></div>
</div>
</section>
<section id="fix-kernel-or-other-files-2018-4-6">
<h3 id="fix-kernel-or-other-files-2018-4-6">Fix kernel or other files 2018/4/6<a class="headerlink" href="#fix-kernel-or-other-files-2018-4-6" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">yaourt</span> <span class="pre">-Syu</span></code> が妙に時間がかかったのでマシンを途中で止めてしまったと
ころ、起動時（LUKSのパスワード入力）時にキーボードが効かなくなり、パス
ワードを入力できなくなった。このためその後のブートシーケンスを継続でき
ない。</p>
<p>まずは起動して <code class="docutils literal notranslate"><span class="pre">yaourt</span> <span class="pre">-Syu</span></code> の続きを完了することを目指す。ブートディ
スクを使って、まずブートディスクのカーネルで起動しておく。それでchroot
環境をつくる。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># cryptsetup open /dev/nvme0n1p2 crypt-root</span>
<span class="n">Enter</span> <span class="n">passphrase</span> <span class="k">for</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p2</span><span class="p">:</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># mount /dev/mapper/crypt-root /mnt</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># mount /dev/nvme0n1p1 /mnt/boot</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># timedatectl set-ntp true</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># timedatectl status</span>
<span class="o">...</span>
<span class="c1"># arch-chroot /mnt</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@archiso</span> <span class="o">/</span><span class="p">]</span><span class="c1"># yaourt -Syu</span>
</pre></div>
</div>
<p>とやると、 <code class="docutils literal notranslate"><span class="pre">pacman</span> <span class="pre">-Syu</span></code> やってるんじゃないの？といわれる。定番のロッ
クファイルが残っているやつなのでロックファイルを消す。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@archiso</span> <span class="o">/</span><span class="p">]</span><span class="c1"># rm /var/lib/pacman/db.lck</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@archiso</span> <span class="o">/</span><span class="p">]</span><span class="c1"># yaourt -Syu</span>
<span class="o">...</span>
</pre></div>
</div>
<p>今度は普通に最後まで動く。というわけでchroot環境を出てから再起動
<code class="docutils literal notranslate"><span class="pre">shutdown</span> <span class="pre">-r</span> <span class="pre">now</span></code> してみてもやっぱりパスワードを入力できない（キーボー
ドが使えていない）。はっそういえば…と思いなおして、また同じ手順を繰り
返して chroot 環境に入って、:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="nd">@archiso</span> <span class="o">/</span><span class="p">]</span><span class="c1"># mkinitcpio -p linux</span>
<span class="o">...</span>
</pre></div>
</div>
<p>として、 initrd を作り直して再起動したところ無事にキーボードが使えるよ
うになった。おそらくは vmlinuz (カーネルのファイル) を作っただけで
initrd を再作成していなかったため何かがズレて起動だけはするけどキーボー
ドが使えなくなっていたのだろうと思われる。教訓: カーネルのアップデート
途中に電源長押しで再起動なんかしてはいけないし、 <em>金曜夕方の退勤間際に
間違ってもOSのアップデートなんかしてはいけない</em> 。</p>
</section>
<section id="id9">
<h3 id="id9">急にWiFiがつながらなくなったら<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<p>パソコンのハードスイッチからオフになっている可能性がある。推し間違いなど。
<code class="docutils literal notranslate"><span class="pre">rfkill</span></code> で状態を確認できるので、それ経由でオンにするとつながる。</p>
</section>
</section>
</section>


          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="../opensource.html" title="Open Source Contributions"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> Open Source Contributions </span>
              </div>
            </a>
          
          
            <a href="zfs.html" title="ZFS Memo"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> Next </span> ZFS Memo </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2012-2022, UENISHI Kota.
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>