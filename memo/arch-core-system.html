<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Arch Linux Installation &amp; Maintenance &#8212; kuenishi(7)</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/pyramid.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Arch Linux Setup (GUI)" href="arch-gui.html" />
    <link rel="prev" title="Persona" href="../persona.html" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head><body>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="arch-gui.html" title="Arch Linux Setup (GUI)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../persona.html" title="Persona"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">kuenishi(7)</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Arch Linux Installation &amp; Maintenance</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="arch-linux-installation-maintenance">
<h1>Arch Linux Installation &amp; Maintenance<a class="headerlink" href="#arch-linux-installation-maintenance" title="Permalink to this heading">¶</a></h1>
<p>2017/10/19 - 2017/10/20</p>
<p>2018/9/9 Mac mini mid 2011 のインストールを追加
2018/3/15 カーネルパッチの部分を削除
2018/4/6 Trouble Shooting追加
2020/6/17 btrfs まわりを追加</p>
<section id="iso-image-download">
<h2>ISO Image Download<a class="headerlink" href="#iso-image-download" title="Permalink to this heading">¶</a></h2>
<p><a class="reference external" href="https://www.archlinux.org/download/">https://www.archlinux.org/download/</a> からPGP署名ファイルとISOイメージをダウンロード:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ wget http://ftp.jaist.ac.jp/pub/Linux/ArchLinux/iso/2017.10.01/archlinux-2017.10.01-x86_64.iso
$ wget https://www.archlinux.org/iso/2017.10.01/archlinux-2017.10.01-x86_64.iso.sig
$ ls archlinux*
archlinux-2017.10.01-x86_64.iso  archlinux-2017.10.01-x86_64.iso.sig
</pre></div>
</div>
<p>ダウンロードしたファイルの検証。公開鍵がないので一旦失敗する:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ LANG=C gpg --verbose --verify archlinux-2017.10.01-x86_64.iso.sig
gpg: assuming signed data in &#39;archlinux-2017.10.01-x86_64.iso&#39;
gpg: Signature made Sun Oct  1 14:29:43 2017 JST
gpg:                using RSA key 4AA4767BBC9C4B1D18AE28B77F2D434B9741E8AC
gpg: Can&#39;t check signature: No public key
</pre></div>
</div>
<p>公開鍵を調べてとりあえずインポートする:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gpg --search-key 4AA4767BBC9C4B1D18AE28B77F2D434B9741E8AC
gpg: data source: https://176.9.147.41:443
(1)     Pierre Schmitz &lt;pierre@archlinux.de&gt;
        2048 bit RSA key 7F2D434B9741E8AC, 作成: 2011-04-10
Keys 1-1 of 1 for &quot;4AA4767BBC9C4B1D18AE28B77F2D434B9741E8AC&quot;.  番号(s)、N)次、またはQ)中止を入力してください &gt;N
$ gpg --recv-keys  7F2D434B9741E8AC
gpg: 鍵7F2D434B9741E8AC: 公開鍵&quot;Pierre Schmitz &lt;pierre@archlinux.de&gt;&quot;をインポートしました
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: 深さ: 0  有効性:   2  署名:   1  信用: 0-, 0q, 0n, 0m, 0f, 2u
gpg: 深さ: 1  有効性:   1  署名:   0  信用: 0-, 0q, 0n, 0m, 1f, 0u
gpg: 次回の信用データベース検査は、2018-07-11です
gpg:           処理数の合計: 1
gpg:             インポート: 1
</pre></div>
</div>
<p>改めてVerify:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ LANG=C gpg --verify archlinux-2017.10.01-x86_64.iso.sig
gpg: assuming signed data in &#39;archlinux-2017.10.01-x86_64.iso&#39;
gpg: Signature made Sun Oct  1 14:29:43 2017 JST
gpg:                using RSA key 4AA4767BBC9C4B1D18AE28B77F2D434B9741E8AC
gpg: Good signature from &quot;Pierre Schmitz &lt;pierre@archlinux.de&gt;&quot; [unknown]
gpg: WARNING: This key is not certified with a trusted signature!
gpg:          There is no indication that the signature belongs to the owner.
Primary key fingerprint: 4AA4 767B BC9C 4B1D 18AE  28B7 7F2D 434B 9741 E8AC
</pre></div>
</div>
<p><a class="reference external" href="https://wiki.archlinux.jp/index.php/USB_%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%83%A1%E3%83%87%E3%82%A3%E3%82%A2">イメージをUSBメモリに焼く</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo dmesg | tail
[ 6587.846736] scsi 8:0:0:0: Direct-Access     Ut165    USB2FlashStorage 0.00 PQ: 0 ANSI: 2
[ 6587.847379] sd 8:0:0:0: Attached scsi generic sg6 type 0
[ 6587.848372] sd 8:0:0:0: [sdf] 7897040 512-byte logical blocks: (4.04 GB/3.76 GiB)
[ 6587.849183] sd 8:0:0:0: [sdf] Write Protect is off
[ 6587.849185] sd 8:0:0:0: [sdf] Mode Sense: 00 00 00 00
[ 6587.850081] sd 8:0:0:0: [sdf] Asking for cache data failed
[ 6587.850087] sd 8:0:0:0: [sdf] Assuming drive cache: write through
[ 6588.007742]  sdf:
[ 6588.400298] sd 8:0:0:0: [sdf] Attached SCSI removable disk
[ 7272.546160]  sdf: sdf1 sdf2
$ sudo dd if=archlinux-2017.10.01-x86_64.iso of=/dev/sdf status=progress &amp;&amp; sudo sync
544993792 bytes (545 MB, 520 MiB) copied, 189 s, 2.9 MB/s
1071104+0 レコード入力
1071104+0 レコード出力
548405248 bytes (548 MB, 523 MiB) copied, 201.131 s, 2.7 MB/s
</pre></div>
</div>
</section>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this heading">¶</a></h2>
<p>ThinkPad届く。</p>
<p>Secure Bootをオフに必ずしておく。
Bootパスはまあこの際後でもいっか。</p>
<p>Windows Proのライセンスキーがパッケージや本体のどこにも書いてないので、
Windowsを起動して一旦プロダクトキーを抜いておく（おそらくThinkPadのCPU
IDかシリアルナンバーか何かをみて認証していると思われる。ブート後:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># passwd</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># systemctl start sshd</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># ip addr</span>
</pre></div>
</div>
<p>以後SSHで入って作業（優先で接続するために予めRJ45アダプタを買っておく）。ディスク名を確認:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># fdisk -l</span>
<span class="n">Disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span><span class="p">:</span> <span class="mi">477</span> <span class="n">GiB</span><span class="p">,</span> <span class="mi">512110190592</span> <span class="nb">bytes</span><span class="p">,</span> <span class="mi">1000215216</span> <span class="n">sectors</span>
<span class="n">Units</span><span class="p">:</span> <span class="n">sectors</span> <span class="n">of</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">=</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">Sector</span> <span class="n">size</span> <span class="p">(</span><span class="n">logical</span><span class="o">/</span><span class="n">physical</span><span class="p">):</span> <span class="mi">512</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">size</span> <span class="p">(</span><span class="n">minimum</span><span class="o">/</span><span class="n">optimal</span><span class="p">):</span> <span class="mi">512</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">Disklabel</span> <span class="nb">type</span><span class="p">:</span> <span class="n">gpt</span>
<span class="n">Disk</span> <span class="n">identifier</span><span class="p">:</span> <span class="mi">25</span><span class="n">A27C49</span><span class="o">-</span><span class="mi">25</span><span class="n">BC</span><span class="o">-</span><span class="mi">4715</span><span class="o">-</span><span class="mi">8</span><span class="n">A09</span><span class="o">-</span><span class="n">A722ABE9260D</span>

<span class="n">Device</span>             <span class="n">Start</span>        <span class="n">End</span>   <span class="n">Sectors</span>   <span class="n">Size</span> <span class="n">Type</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>      <span class="mi">2048</span>     <span class="mi">534527</span>    <span class="mi">532480</span>   <span class="mi">260</span><span class="n">M</span> <span class="n">EFI</span> <span class="n">System</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p2</span>    <span class="mi">534528</span>     <span class="mi">567295</span>     <span class="mi">32768</span>    <span class="mi">16</span><span class="n">M</span> <span class="n">Microsoft</span> <span class="n">reserved</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p3</span>    <span class="mi">567296</span>  <span class="mi">998166527</span> <span class="mi">997599232</span> <span class="mf">475.7</span><span class="n">G</span> <span class="n">Microsoft</span> <span class="n">basic</span> <span class="n">data</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p4</span> <span class="mi">998166528</span> <span class="mi">1000214527</span>   <span class="mi">2048000</span>  <span class="mi">1000</span><span class="n">M</span> <span class="n">Windows</span> <span class="n">recovery</span> <span class="n">environment</span>
</pre></div>
</div>
<p>パーティションを切る:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># parted /dev/nvme0n1 -s mklabel gpt -s mkpart ESP fat32 1MiB 513MiB -s set 1 boot on -s mkpart primary ext4 513MiB 100%</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># fdisk -l</span>
<span class="n">Disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span><span class="p">:</span> <span class="mi">477</span> <span class="n">GiB</span><span class="p">,</span> <span class="mi">512110190592</span> <span class="nb">bytes</span><span class="p">,</span> <span class="mi">1000215216</span> <span class="n">sectors</span>
<span class="n">Units</span><span class="p">:</span> <span class="n">sectors</span> <span class="n">of</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">512</span> <span class="o">=</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">Sector</span> <span class="n">size</span> <span class="p">(</span><span class="n">logical</span><span class="o">/</span><span class="n">physical</span><span class="p">):</span> <span class="mi">512</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">I</span><span class="o">/</span><span class="n">O</span> <span class="n">size</span> <span class="p">(</span><span class="n">minimum</span><span class="o">/</span><span class="n">optimal</span><span class="p">):</span> <span class="mi">512</span> <span class="nb">bytes</span> <span class="o">/</span> <span class="mi">512</span> <span class="nb">bytes</span>
<span class="n">Disklabel</span> <span class="nb">type</span><span class="p">:</span> <span class="n">gpt</span>
<span class="n">Disk</span> <span class="n">identifier</span><span class="p">:</span> <span class="mf">1E26</span><span class="n">B015</span><span class="o">-</span><span class="n">ABC4</span><span class="o">-</span><span class="mi">4949</span><span class="o">-</span><span class="mi">8410</span><span class="o">-</span><span class="mi">7</span><span class="n">F43A11ECE11</span>

<span class="n">Device</span>           <span class="n">Start</span>        <span class="n">End</span>   <span class="n">Sectors</span>   <span class="n">Size</span> <span class="n">Type</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p1</span>    <span class="mi">2048</span>    <span class="mi">1050623</span>   <span class="mi">1048576</span>   <span class="mi">512</span><span class="n">M</span> <span class="n">EFI</span> <span class="n">System</span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p2</span> <span class="mi">1050624</span> <span class="mi">1000214527</span> <span class="mi">999163904</span> <span class="mf">476.4</span><span class="n">G</span> <span class="n">Linux</span> <span class="n">filesystem</span>
</pre></div>
</div>
<p>ブートセクタをフォーマットする:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># mkfs.vfat -F32 /dev/nvme0n1p1</span>
<span class="n">mkfs</span><span class="o">.</span><span class="n">fat</span> <span class="mf">4.1</span> <span class="p">(</span><span class="mi">2017</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">24</span><span class="p">)</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># parted /dev/nvme0n1 print</span>
<span class="n">Model</span><span class="p">:</span> <span class="n">Unknown</span> <span class="p">(</span><span class="n">unknown</span><span class="p">)</span>
<span class="n">Disk</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1</span><span class="p">:</span> <span class="mi">512</span><span class="n">GB</span>
<span class="n">Sector</span> <span class="n">size</span> <span class="p">(</span><span class="n">logical</span><span class="o">/</span><span class="n">physical</span><span class="p">):</span> <span class="mi">512</span><span class="n">B</span><span class="o">/</span><span class="mi">512</span><span class="n">B</span>
<span class="n">Partition</span> <span class="n">Table</span><span class="p">:</span> <span class="n">gpt</span>
<span class="n">Disk</span> <span class="n">Flags</span><span class="p">:</span>

<span class="n">Number</span>  <span class="n">Start</span>   <span class="n">End</span>    <span class="n">Size</span>   <span class="n">File</span> <span class="n">system</span>  <span class="n">Name</span>  <span class="n">Flags</span>
<span class="mi">1</span>      <span class="mi">1049</span><span class="n">kB</span>  <span class="mi">538</span><span class="n">MB</span>  <span class="mi">537</span><span class="n">MB</span>  <span class="n">fat32</span>              <span class="n">boot</span><span class="p">,</span> <span class="n">esp</span>
<span class="mi">2</span>      <span class="mi">538</span><span class="n">MB</span>   <span class="mi">512</span><span class="n">GB</span>  <span class="mi">512</span><span class="n">GB</span>
</pre></div>
</div>
<p>ルートパーティションを暗号化する。このとき入れるパスワードが、マシン起
動のときに毎回きかれるパスワードになる。このパスワードを覚えておけばあ
とで追加もできる。というか、覚えられるパスワードにしておこう。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>root@archiso ~ # cryptsetup luksFormat /dev/nvme0n1p2

WARNING!
========
This will overwrite data on /dev/nvme0n1p2 irrevocably.

Are you sure? (Type uppercase yes): YES
Enter passphrase:
Verify passphrase:
</pre></div>
</div>
<p>LUKSはかなり高機能で、YubiKeyで鍵を渡して起動とか、USBメモリ上の特定の
パスから拾ってくるとかいろいろできるらしい。initrdの中にパスワードファ
イルを仕込んでおくこともできるが、ここは素直に覚えやすいものを設定して
おくことにした。暗号化したやつをDevice Mapperで見えるようにする。ここ
では <code class="docutils literal notranslate"><span class="pre">crypt-root</span></code> と適当に名前をつける。それを ext4 でフォーマットま
でしとく。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># cryptsetup open /dev/nvme0n1p2 crypt-root</span>
<span class="n">Enter</span> <span class="n">passphrase</span> <span class="k">for</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">nvme0n1p2</span><span class="p">:</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># mkfs.ext4 /dev/mapper/crypt-root</span>
<span class="n">mke2fs</span> <span class="mf">1.43.6</span> <span class="p">(</span><span class="mi">29</span><span class="o">-</span><span class="n">Aug</span><span class="o">-</span><span class="mi">2017</span><span class="p">)</span>
<span class="n">Creating</span> <span class="n">filesystem</span> <span class="k">with</span> <span class="mi">124894976</span> <span class="mi">4</span><span class="n">k</span> <span class="n">blocks</span> <span class="ow">and</span> <span class="mi">31227904</span> <span class="n">inodes</span>
<span class="n">Filesystem</span> <span class="n">UUID</span><span class="p">:</span> <span class="mi">01</span><span class="n">dbc4c4</span><span class="o">-</span><span class="n">bebe</span><span class="o">-</span><span class="mi">4</span><span class="n">ee5</span><span class="o">-</span><span class="mi">92</span><span class="n">a1</span><span class="o">-</span><span class="mi">2568</span><span class="n">aaef4c1f</span>
<span class="n">Superblock</span> <span class="n">backups</span> <span class="n">stored</span> <span class="n">on</span> <span class="n">blocks</span><span class="p">:</span>
      <span class="mi">32768</span><span class="p">,</span> <span class="mi">98304</span><span class="p">,</span> <span class="mi">163840</span><span class="p">,</span> <span class="mi">229376</span><span class="p">,</span> <span class="mi">294912</span><span class="p">,</span> <span class="mi">819200</span><span class="p">,</span> <span class="mi">884736</span><span class="p">,</span> <span class="mi">1605632</span><span class="p">,</span> <span class="mi">2654208</span><span class="p">,</span>
      <span class="mi">4096000</span><span class="p">,</span> <span class="mi">7962624</span><span class="p">,</span> <span class="mi">11239424</span><span class="p">,</span> <span class="mi">20480000</span><span class="p">,</span> <span class="mi">23887872</span><span class="p">,</span> <span class="mi">71663616</span><span class="p">,</span> <span class="mi">78675968</span><span class="p">,</span>
      <span class="mi">102400000</span>

      <span class="n">Allocating</span> <span class="n">group</span> <span class="n">tables</span><span class="p">:</span> <span class="n">done</span>
      <span class="n">Writing</span> <span class="n">inode</span> <span class="n">tables</span><span class="p">:</span> <span class="n">done</span>
      <span class="n">Creating</span> <span class="n">journal</span> <span class="p">(</span><span class="mi">262144</span> <span class="n">blocks</span><span class="p">):</span> <span class="n">done</span>
      <span class="n">Writing</span> <span class="n">superblocks</span> <span class="ow">and</span> <span class="n">filesystem</span> <span class="n">accounting</span> <span class="n">information</span><span class="p">:</span> <span class="n">done</span>
</pre></div>
</div>
<p>フォーマットしたものをと、ブートパーティションをマウントする。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># mount /dev/mapper/crypt-root /mnt</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># mount /dev/nvme0n1p1 /mnt/boot</span>
<span class="n">mount</span><span class="p">:</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="p">:</span> <span class="n">mount</span> <span class="n">point</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">exist</span><span class="o">.</span>
<span class="mi">32</span> <span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># mkdir /mnt/boot</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># mount /dev/nvme0n1p1 /mnt/boot</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># timedatectl set-ntp true</span>
<span class="n">root</span><span class="nd">@archiso</span> <span class="o">~</span> <span class="c1"># timedatectl status</span>
      <span class="n">Local</span> <span class="n">time</span><span class="p">:</span> <span class="n">Thu</span> <span class="mi">2017</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span> <span class="mi">03</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">12</span> <span class="n">UTC</span>
  <span class="n">Universal</span> <span class="n">time</span><span class="p">:</span> <span class="n">Thu</span> <span class="mi">2017</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span> <span class="mi">03</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">12</span> <span class="n">UTC</span>
        <span class="n">RTC</span> <span class="n">time</span><span class="p">:</span> <span class="n">Thu</span> <span class="mi">2017</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">19</span> <span class="mi">03</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">12</span>
       <span class="n">Time</span> <span class="n">zone</span><span class="p">:</span> <span class="n">UTC</span> <span class="p">(</span><span class="n">UTC</span><span class="p">,</span> <span class="o">+</span><span class="mi">0000</span><span class="p">)</span>
 <span class="n">Network</span> <span class="n">time</span> <span class="n">on</span><span class="p">:</span> <span class="n">yes</span>
<span class="n">NTP</span> <span class="n">synchronized</span><span class="p">:</span> <span class="n">yes</span>
 <span class="n">RTC</span> <span class="ow">in</span> <span class="n">local</span> <span class="n">TZ</span><span class="p">:</span> <span class="n">no</span>
</pre></div>
</div>
<p>ミラーを日本だけのものにしとく。grepだと ‘–’ という余計なものが入るの
で、消しておくこと。ベースシステムを <code class="docutils literal notranslate"><span class="pre">pacstrap</span></code> でインストールしてか
ら、この時点で <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> を作っておく。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> # grep Japan -A 1 /etc/pacman.d/mirrorlist &gt; mirrorlist
 (remove  -- here)
 # vi mirrorlist
 # mv mirrorlist /etc/pacman.d/
 # pacstrap /mnt base base-devel linux linux-firmware
 # genfstab -U /mnt &gt;&gt; /mnt/etc/fstab

``chroot`` して、OS環境の作成を開始する。まず、基本的なファイルを先においておく。::

 root@archiso ~ # arch-chroot /mnt
 [root@archiso /]# ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
 [root@archiso /]# echo &quot;LANG=en_US.UTF-8&quot; &gt; /etc/locale.conf
 [root@archiso /]# locale-gen
 [root@archiso /]# echo KEYMAP=us &gt; /etc/vconsole.conf
 [root@archiso /]# echo utaha &gt; /etc/hostname
 [root@archiso /]# pacman -S emacs-nox
 [root@archiso /]# emacs /etc/hosts
 (set hostname.localdomain)
</pre></div>
</div>
<p>ひととおり設定できたら、initramfsを作る。 <code class="docutils literal notranslate"><span class="pre">/etc/mkinitcpio.conf</span></code> を
編集して、 <code class="docutils literal notranslate"><span class="pre">systemd</span></code> と <code class="docutils literal notranslate"><span class="pre">sd-encrypt</span></code> を <a class="reference external" href="https://wiki.archlinux.org/index.php/Dm-crypt/System_configuration#mkinitcpio">HOOKSに追加する</a>
。いまのところはこういう並びでうまくいっている。 <code class="docutils literal notranslate"><span class="pre">sd-encrypt</span></code> は <code class="docutils literal notranslate"><span class="pre">block</span></code> の前にないとだめそう。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HOOKS</span><span class="o">=</span><span class="s2">&quot;base systemd udev autodetect modconf sd-encrypt block filesystems keyboard fsck&quot;</span>
</pre></div>
</div>
<p>巷には LVM と <code class="docutils literal notranslate"><span class="pre">encrypt</span></code> を使ってなぜか <code class="docutils literal notranslate"><span class="pre">systemd-boot</span></code> でうまく行っ
ている例があるみたいだが、少なくとも手元では成功しなかったので鵜呑みに
するのは危険だろう。 <a class="reference external" href="https://bbs.archlinux.org/viewtopic.php?pid=1673320#p1673320">If you use the systemd hook then you have to use
sd-encrypt and
sd-lvm.</a>
とも書いてあるし。これが編集できたら initrd を作成。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># mkinitcpio -p linux</span>
</pre></div>
</div>
<p>次はブートセクタの作成。まずUUIDを確認して、とりあえずもろもろのファイルを作っておく。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cryptsetup luksUUID /dev/nvme0n1p2</span>
<span class="mi">1</span><span class="n">cf54a61</span><span class="o">-</span><span class="n">cd17</span><span class="o">-</span><span class="mf">43e3</span><span class="o">-</span><span class="n">ad00</span><span class="o">-</span><span class="n">bf94c29dc922</span>
<span class="c1"># bootctl --path=/boot install</span>
<span class="c1"># pacman -S intel-ucode</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">intel-ucode</span></code> は <a class="reference external" href="https://wiki.archlinux.jp/index.php/%E3%83%9E%E3%82%A4%E3%82%AF%E3%83%AD%E3%82%B3%E3%83%BC%E3%83%89#Intel_.E3.81.AE.E3.83.9E.E3.82.A4.E3.82.AF.E3.83.AD.E3.82.B3.E3.83.BC.E3.83.89.E3.81.AE.E3.82.A2.E3.83.83.E3.83.97.E3.83.87.E3.83.BC.E3.83.88.E3.82.92.E6.9C.89.E5.8A.B9.E3.81.AB.E3.81.99.E3.82.8B">CPUのマイクロコードをアップデートしてくれるものらしい</a> 。</p>
<p>次にブートローダの設定を作成。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># emacs /boot/loader/loader.conf</span>
<span class="c1"># cat /boot/loader/loader.conf</span>
<span class="n">timeout</span> <span class="mi">5</span>
<span class="c1">## default 64783ef8e33e4205862d8f26c79b569c-*</span>
<span class="n">default</span> <span class="n">encrypted</span><span class="o">-</span><span class="n">arch</span><span class="o">.</span><span class="n">conf</span>
<span class="n">editor</span> <span class="mi">0</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">timeout</span> <span class="pre">5</span></code> は、ブートローダーに入ってから、ブートエントリの切り替え
を5秒だけ待ってくれるやつだ。5秒たつとデフォルトのブートエントリに入っ
ていく。デフォルトのブートエントリは:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cat /boot/loader/entries/encrypted-arch.conf</span>
<span class="n">title</span> <span class="n">Arch</span> <span class="n">Linux</span> <span class="n">Encrypted</span>
<span class="n">linux</span> <span class="o">/</span><span class="n">vmlinuz</span><span class="o">-</span><span class="n">linux</span>
<span class="n">initrd</span> <span class="o">/</span><span class="n">intel</span><span class="o">-</span><span class="n">ucode</span><span class="o">.</span><span class="n">img</span>
<span class="n">initrd</span> <span class="o">/</span><span class="n">initramfs</span><span class="o">-</span><span class="n">linux</span><span class="o">.</span><span class="n">img</span>
<span class="n">options</span> <span class="n">luks</span><span class="o">.</span><span class="n">uuid</span><span class="o">=</span><span class="mi">1</span><span class="n">cf54a61</span><span class="o">-</span><span class="n">cd17</span><span class="o">-</span><span class="mf">43e3</span><span class="o">-</span><span class="n">ad00</span><span class="o">-</span><span class="n">bf94c29dc922</span> <span class="n">luks</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="mi">1</span><span class="n">cf54a61</span><span class="o">-</span><span class="n">cd17</span><span class="o">-</span><span class="mf">43e3</span><span class="o">-</span><span class="n">ad00</span><span class="o">-</span><span class="n">bf94c29dc922</span><span class="o">=</span><span class="n">crypt</span><span class="o">-</span><span class="n">root</span> <span class="n">root</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">crypt</span><span class="o">-</span><span class="n">root</span> <span class="n">rw</span> <span class="n">intel_pstate</span><span class="o">=</span><span class="n">no_hwp</span>
</pre></div>
</div>
<p><a class="reference external" href="https://wiki.archlinux.jp/index.php/Dm-crypt/%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E8%A8%AD%E5%AE%9A">↑はdm-cryptのやつ</a> をみながら編集した。</p>
<p>起動したときにファイルシステムのパスフレーズを要求されて、 login ttyが出れば成功。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># sync</span>
<span class="c1"># systemctl reboot</span>
</pre></div>
</div>
<p>しかしこれでは後々マウスが動かないので、あとでこのカーネルをAURでアップデートすることになる。</p>
<ul class="simple">
<li><p><a class="reference external" href="https://wiki.archlinux.jp/index.php/Systemd-boot">https://wiki.archlinux.jp/index.php/Systemd-boot</a></p></li>
</ul>
</section>
<section id="reference">
<h2>Reference<a class="headerlink" href="#reference" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://wiki.archlinux.jp/index.php/%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%82%AC%E3%82%A4%E3%83%89">インストールガイド</a></p></li>
<li><p><a class="reference external" href="https://wiki.archlinux.org/index.php/Lenovo_ThinkPad_X1_Carbon_(Gen_5)">Lenovo ThinkPad X1 Carbon (Gen 5)</a></p></li>
<li><p><a class="reference external" href="http://www.thinkwiki.org/wiki/Category:X1_Carbon_(5th_Gen)">Category:X1 Carbon (5th Gen)</a></p></li>
<li><p><a class="reference external" href="https://gist.github.com/HardenedArray/31915e3d73a4ae45adc0efa9ba458b07">Efficient Encrypted UEFI-Booting Arch Installation</a></p></li>
<li><p><a class="reference external" href="https://qiita.com/miy4/items/796c51813417cc90c77f">Thinkpad X1 Carbon (Gen 4)にArch Linuxをインストールする</a> &lt;- なぜ systemd hook をつけてないのに systemd-boot でブートローダーが作れるんだ？</p></li>
</ul>
</section>
<section id="arch-linux-installation-to-machine-2">
<h2>Arch Linux Installation to machine #2<a class="headerlink" href="#arch-linux-installation-to-machine-2" title="Permalink to this heading">¶</a></h2>
<p>2018/2/4</p>
<p>To my desktop machine, with NVIDIA GeForce 760, and several hetero HDDs.</p>
<section id="os-install">
<h3>OS Install<a class="headerlink" href="#os-install" title="Permalink to this heading">¶</a></h3>
<p>Same os above, using many tools to setup Arch Installation, except for:</p>
<ul class="simple">
<li><p>No HDD encryption</p></li>
<li><p>No kernel build for ThinkPad; it’s just commodity desktop</p></li>
<li><p>Btrfs for /home: <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">mount</span> <span class="pre">/mnt/home</span> <span class="pre">/dev/sdb</span></code> where sdb is one of Btrfs disks</p></li>
<li><p>Static IP address configuration</p></li>
<li><p>NVIDIA driver</p></li>
</ul>
</section>
<section id="btrfs-setup">
<h3>Btrfs setup<a class="headerlink" href="#btrfs-setup" title="Permalink to this heading">¶</a></h3>
<p>See <a class="reference external" href="https://btrfs.wiki.kernel.org/index.php/Using_Btrfs_with_Multiple_Devices">Using Btrfs with Multiple Devices</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># mkfs.btrfs -d single /dev/sdb /dev/sdc /dev/sdd /dev/sde</span>
<span class="c1"># mount /dev/sde /mnt</span>
</pre></div>
</div>
<p>単体の例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># mkfs.btrfs -d single /dev/sdf</span>
<span class="n">btrfs</span><span class="o">-</span><span class="n">progs</span> <span class="n">v5</span><span class="mf">.6.1</span>
<span class="n">See</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">btrfs</span><span class="o">.</span><span class="n">wiki</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">org</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>

<span class="n">Detected</span> <span class="n">a</span> <span class="n">SSD</span><span class="p">,</span> <span class="n">turning</span> <span class="n">off</span> <span class="n">metadata</span> <span class="n">duplication</span><span class="o">.</span>  <span class="n">Mkfs</span> <span class="k">with</span> <span class="o">-</span><span class="n">m</span> <span class="n">dup</span> <span class="k">if</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">force</span> <span class="n">metadata</span> <span class="n">duplication</span><span class="o">.</span>
<span class="n">Label</span><span class="p">:</span>              <span class="p">(</span><span class="n">null</span><span class="p">)</span>
<span class="n">UUID</span><span class="p">:</span>               <span class="n">e092a2dc</span><span class="o">-</span><span class="n">b65d</span><span class="o">-</span><span class="mf">45e4</span><span class="o">-</span><span class="mi">8</span><span class="n">dee</span><span class="o">-</span><span class="mi">46529</span><span class="n">c1949a0</span>
<span class="n">Node</span> <span class="n">size</span><span class="p">:</span>          <span class="mi">16384</span>
<span class="n">Sector</span> <span class="n">size</span><span class="p">:</span>        <span class="mi">4096</span>
<span class="n">Filesystem</span> <span class="n">size</span><span class="p">:</span>    <span class="mf">931.51</span><span class="n">GiB</span>
<span class="n">Block</span> <span class="n">group</span> <span class="n">profiles</span><span class="p">:</span>
  <span class="n">Data</span><span class="p">:</span>             <span class="n">single</span>            <span class="mf">8.00</span><span class="n">MiB</span>
  <span class="n">Metadata</span><span class="p">:</span>         <span class="n">single</span>            <span class="mf">8.00</span><span class="n">MiB</span>
  <span class="n">System</span><span class="p">:</span>           <span class="n">single</span>            <span class="mf">4.00</span><span class="n">MiB</span>
<span class="n">SSD</span> <span class="n">detected</span><span class="p">:</span>       <span class="n">yes</span>
<span class="n">Incompat</span> <span class="n">features</span><span class="p">:</span>  <span class="n">extref</span><span class="p">,</span> <span class="n">skinny</span><span class="o">-</span><span class="n">metadata</span>
<span class="n">Checksum</span><span class="p">:</span>           <span class="n">crc32c</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">devices</span><span class="p">:</span>  <span class="mi">1</span>
<span class="n">Devices</span><span class="p">:</span>
   <span class="n">ID</span>        <span class="n">SIZE</span>  <span class="n">PATH</span>
    <span class="mi">1</span>   <span class="mf">931.51</span><span class="n">GiB</span>  <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdf</span>
</pre></div>
</div>
<p>マウントしてサブボリュームを作る:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># mount /dev/sdf /mnt</span>
<span class="c1"># btrfs sub create /mnt/kuenishi</span>
<span class="c1"># chown kuenishi:kuenishi /mnt/kuenishi</span>
</pre></div>
</div>
<p>いろいろファイルをコピーする:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cd
$ mv -v * /mnt/kuenishi/
$ cp -v -r .* /mnt/kuenishi/
</pre></div>
</div>
<p>サブボリュームを <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> に書く:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UUID</span><span class="o">=</span><span class="n">e092a2dc</span><span class="o">-</span><span class="n">b65d</span><span class="o">-</span><span class="mf">45e4</span><span class="o">-</span><span class="mi">8</span><span class="n">dee</span><span class="o">-</span><span class="mi">46529</span><span class="n">c1949a0</span>       <span class="o">/</span><span class="n">home</span>           <span class="n">btrfs</span>           <span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">space_cache</span><span class="p">,</span><span class="n">subvolid</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">subvol</span><span class="o">=/</span>     <span class="mi">0</span> <span class="mi">0</span>
</pre></div>
</div>
<p>これで再起動するとホームディレクトリが btrfs のパーティションになっているはずだ。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo btrfs filesystem show /home
Label: none  uuid: e092a2dc-b65d-45e4-8dee-46529c1949a0
        Total devices 1 FS bytes used 32.64GiB
        devid    1 size 931.51GiB used 36.01GiB path /dev/sdf
</pre></div>
</div>
<p>以前作った大きめの btrfs ボリュームが <code class="docutils literal notranslate"><span class="pre">/data</span></code> にあるものとする。予め
スナップショット用のサブボリュームを作っておく。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># btrfs sub create /home/ss</span>
<span class="c1"># btrfs sub create /data/home-backup</span>
</pre></div>
</div>
<p>今度はバックアップを実行する。シェルにしてしまった。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/sh

set -eux

TS=`date &#39;+%Y%m%d-%H%M%S&#39;`
btrfs sub snap /home/kuenishi /home/ss/kuenishi-${TS}
btrfs property set -ts /home/ss/kuenishi-${TS} ro true
btrfs send /home/ss/kuenishi-${TS} | btrfs receive /data/home-backup
btrfs sub delete /home/ss/kuenishi-${TS}
</pre></div>
</div>
<p>これであとは適当にcronにでもしておけばよい。あとは Docker を使っている
場合、レイヤーを btrfs に保存する方法は簡単で、 <code class="docutils literal notranslate"><span class="pre">btrfs</span> <span class="pre">sub</span> <span class="pre">create</span>
<span class="pre">/data/docker</span></code> とやってサブボリュームを作っておく。それから、
<code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> に:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UUID</span><span class="o">=</span><span class="mi">5</span><span class="n">fdf336d</span><span class="o">-</span><span class="mi">09</span><span class="n">b3</span><span class="o">-</span><span class="mi">4</span><span class="n">b98</span><span class="o">-</span><span class="mf">8e52</span><span class="o">-</span><span class="n">d78b72ceedcf</span>       <span class="o">/</span><span class="n">data</span>           <span class="n">btrfs</span>           <span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">space_cache</span><span class="p">,</span><span class="n">subvolid</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">subvol</span><span class="o">=/</span>     <span class="mi">0</span> <span class="mi">0</span>
<span class="n">UUID</span><span class="o">=</span><span class="mi">5</span><span class="n">fdf336d</span><span class="o">-</span><span class="mi">09</span><span class="n">b3</span><span class="o">-</span><span class="mi">4</span><span class="n">b98</span><span class="o">-</span><span class="mf">8e52</span><span class="o">-</span><span class="n">d78b72ceedcf</span>       <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">docker</span>         <span class="n">btrfs</span>           <span class="n">rw</span><span class="p">,</span><span class="n">relatime</span><span class="p">,</span><span class="n">space_cache</span><span class="p">,</span><span class="n">subvol</span><span class="o">=</span><span class="n">docker</span>   <span class="mi">0</span> <span class="mi">0</span>
</pre></div>
</div>
<p>とかいておくと、 <code class="docutils literal notranslate"><span class="pre">/data</span></code> にも使われているボリュームを名前を変えて
<code class="docutils literal notranslate"><span class="pre">/var/lib/docker</span></code> に置き換えて使ってくれる。Dockerの方でも、btrfs で
あることを検知して勝手にoverlayしてくれるようになる。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ df -h /data /var/lib/docker
Filesystem      Size  Used Avail Use% Mounted on
/dev/sdb        1.8T  461G  784G  37% /data
/dev/sdb        1.8T  461G  784G  37% /var/lib/docker
</pre></div>
</div>
<p>マシンを再起動する前に一度 <code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">/var/lib/docker/*</span></code> を実行して綺麗
にしておいた方がよいだろう。ちなみにしばらく使ったあとに <code class="docutils literal notranslate"><span class="pre">btrfs</span> <span class="pre">sub</span>
<span class="pre">list</span> <span class="pre">/data</span></code> すると大量のレイヤーが表示されて、Dockerが使われているこ
とがよくわかる。</p>
</section>
<section id="static-ip-address">
<h3>Static IP address<a class="headerlink" href="#static-ip-address" title="Permalink to this heading">¶</a></h3>
<p><a class="reference external" href="https://wiki.archlinux.jp/index.php/Netctl#.E6.9C.89.E7.B7.9A">Use netctl</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ip a</span>
<span class="o">...</span> <span class="p">(</span><span class="n">see</span> <span class="n">device</span> <span class="n">name</span><span class="p">)</span> <span class="o">...</span>
<span class="c1"># cd /etc/netctl</span>
<span class="c1"># cp examples/ethernet-static enp4s0</span>
<span class="c1"># emacs enp4s0</span>
<span class="o">...</span>
<span class="c1"># cat enp4s0</span>
<span class="n">Interface</span><span class="o">=</span><span class="n">enp1s0</span>
<span class="n">Connection</span><span class="o">=</span><span class="n">ethernet</span>
<span class="n">IP</span><span class="o">=</span><span class="n">static</span>
<span class="n">Address</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;10.1.10.2/24&#39;</span><span class="p">)</span>
<span class="n">Gateway</span><span class="o">=</span><span class="s1">&#39;10.1.10.1&#39;</span>
<span class="n">DNS</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;10.1.10.1&#39;</span><span class="p">)</span>
<span class="c1"># netctl start enp4s0   // to start now</span>
<span class="c1"># netctl enable enp4s0  // to enable it on startup</span>
</pre></div>
</div>
<p>Don’t do any fucking typoes here. Troutbleshoot with <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">journalctl</span> <span class="pre">-xe</span></code>, like <a class="reference external" href="https://bbs.archlinux.org/viewtopic.php?id=161263">this</a> .</p>
</section>
<section id="nvidia-driver">
<h3>Nvidia driver<a class="headerlink" href="#nvidia-driver" title="Permalink to this heading">¶</a></h3>
<p>Nouvearu is kind of general and just works - but was too slow for me
at runtime. With <a class="reference external" href="https://wiki.archlinux.org/index.php/NVIDIA">official guide</a> you can find your device version:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ lspci -k | grep -A 2 -E &quot;(VGA|3D)&quot;
</pre></div>
</div>
</section>
<section id="install-yaourt">
<h3>Install yaourt<a class="headerlink" href="#install-yaourt" title="Permalink to this heading">¶</a></h3>
<p>Obsolete… yaourt is not maintained any more.</p>
</section>
</section>
<section id="general-trouble-shooting">
<h2>General Trouble Shooting<a class="headerlink" href="#general-trouble-shooting" title="Permalink to this heading">¶</a></h2>
<section id="locale">
<h3>Locale再生成<a class="headerlink" href="#locale" title="Permalink to this heading">¶</a></h3>
<p>ロケールが変になったらいつでも作り直すことができる。
<code class="docutils literal notranslate"><span class="pre">/etc/locale.gen</span></code> を編集して、必要なロケールのコメントアウトをとりの
ぞく。そのあと再度:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo locale-gen
</pre></div>
</div>
<p>と実行することでロケールが作成される。</p>
<ul class="simple">
<li><p><a class="reference external" href="https://wiki.archlinux.jp/index.php/%E3%83%AD%E3%82%B1%E3%83%BC%E3%83%AB">https://wiki.archlinux.jp/index.php/%E3%83%AD%E3%82%B1%E3%83%BC%E3%83%AB</a></p></li>
</ul>
</section>
<section id="mac-mini-mid-2011">
<h3>Mac Mini mid 2011 にインストール<a class="headerlink" href="#mac-mini-mid-2011" title="Permalink to this heading">¶</a></h3>
<p>2018/9の時点で <a class="reference external" href="https://apple-history.com/mac_mini_mid_11">mid 2011</a>
のモデルが最後のアップデート。もうMacOSは動かないくらいのスペックなの
で、 Arch Linux を入れた。 <a class="reference external" href="https://support.apple.com/ja-jp/HT202796">ブート USB を指して、 Options キーを押しな
がら起動するとブートセレクタに入れる</a> 。 WiFi はBCM43xxなので、
ブート用のISOには入っていないので、有線ネットワークのアクセスがインストールのためには必要。</p>
<p>インストール後は有線がセットアップされていないので:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo pacman -S dhcpcd
$ sudo systemctl start dhcpcd
$ sudo systemctl enable dhcpcd
</pre></div>
</div>
<p>WiFiを使うために</p>
<ul class="simple">
<li><p><a class="reference external" href="https://aur.archlinux.org/packages/yay/">yay</a> をインストール</p></li>
<li><p><a class="reference external" href="https://wiki.archlinux.org/index.php/broadcom_wireless#b43">b43</a> をインストール</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">broadcom-wl</span></code> もインストールして再起動。 dmesg で BCM4331 が見えていることを確認</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">cp</span> <span class="pre">/etc/netctl/examples/wireless-wpa</span> <span class="pre">/etc/netctl/&lt;profile-name&gt;</span></code> をやって内容を編集</p></li>
<li><p>デバイス名は <code class="docutils literal notranslate"><span class="pre">ip</span> <span class="pre">link</span></code> で一覧して結果を確認。それらの内容を <code class="docutils literal notranslate"><span class="pre">/etc/netctl/&lt;profile-name&gt;</span></code> に書き込む</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">netctl;</span> <span class="pre">sudo</span> <span class="pre">netctl</span> <span class="pre">start</span> <span class="pre">&lt;profile-name&gt;</span></code></p></li>
<li><p><a class="reference external" href="https://wiki.archlinux.jp/index.php/Netctl">netctl</a></p></li>
<li><p>多分これでいける</p></li>
</ul>
<p>xorg入れたけどなぜかGUIがでてこない</p>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Arch Linux Installation &amp; Maintenance</a><ul>
<li><a class="reference internal" href="#iso-image-download">ISO Image Download</a></li>
<li><a class="reference internal" href="#installation">Installation</a></li>
<li><a class="reference internal" href="#reference">Reference</a></li>
<li><a class="reference internal" href="#arch-linux-installation-to-machine-2">Arch Linux Installation to machine #2</a><ul>
<li><a class="reference internal" href="#os-install">OS Install</a></li>
<li><a class="reference internal" href="#btrfs-setup">Btrfs setup</a></li>
<li><a class="reference internal" href="#static-ip-address">Static IP address</a></li>
<li><a class="reference internal" href="#nvidia-driver">Nvidia driver</a></li>
<li><a class="reference internal" href="#install-yaourt">Install yaourt</a></li>
</ul>
</li>
<li><a class="reference internal" href="#general-trouble-shooting">General Trouble Shooting</a><ul>
<li><a class="reference internal" href="#locale">Locale再生成</a></li>
<li><a class="reference internal" href="#mac-mini-mid-2011">Mac Mini mid 2011 にインストール</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="../persona.html"
                          title="previous chapter">Persona</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="arch-gui.html"
                          title="next chapter">Arch Linux Setup (GUI)</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/memo/arch-core-system.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="arch-gui.html" title="Arch Linux Setup (GUI)"
             >next</a> |</li>
        <li class="right" >
          <a href="../persona.html" title="Persona"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">kuenishi(7)</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Arch Linux Installation &amp; Maintenance</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2018, UENISHI Kota.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.0.0.
    </div>
  </body>
</html>